# ═══════════════════════════════════════════════════════════════════════════════
# OIP MICROSERVICES ARCHITECTURE
# ═══════════════════════════════════════════════════════════════════════════════
#
# This docker-compose splits the monolithic OIP application into two services:
#
#   oip-daemon-service (port ${PORT:-3005}):
#     The Library Infrastructure - card catalog, shelves, access control
#     - Arweave blockchain indexing
#     - GUN network (private records)
#     - Elasticsearch search
#     - BitTorrent/WebTorrent media
#     - IPFS integration
#     - HD wallet authentication
#     - Organization management
#
#   alexandria-service (port ${ALEXANDRIA_PORT:-3006}):
#     The Librarian - AI, voice, content creation
#     - Alfred AI/RAG
#     - Voice interface (STT/TTS)
#     - Content generation
#     - Web scraping
#     - Photo analysis
#
# PORT CONFIGURATION:
#   All ports are configurable via .env file. Key variables:
#   - PORT: Main OIP daemon API port (default: 3005)
#   - ALEXANDRIA_PORT: Alexandria service port (default: 3006)
#   - ELASTICSEARCH_PORT: Elasticsearch HTTP port (default: 9200)
#   - ELASTICSEARCH_TRANSPORT_PORT: Elasticsearch transport (default: 9300)
#   - KIBANA_PORT: Kibana dashboard (default: 5601)
#   - GUN_RELAY_PORT: GUN relay (default: 8765)
#   - IPFS_API_PORT: IPFS API (default: 5001)
#   - IPFS_GATEWAY_PORT: IPFS Gateway (default: 8080)
#   - OLLAMA_PORT: Ollama LLM (default: 11434)
#   - TTS_SERVICE_PORT: Text-to-Speech (default: 8005)
#   - STT_SERVICE_PORT: Speech-to-Text (default: 8003)
#   - ARIO_GATEWAY_PORT: AR.IO gateway (default: 4000)
#   - DEBUG_PORT: Node.js debug port (default: 9229)
#   - NGROK_DASHBOARD_PORT: Ngrok dashboard (default: 4040)
#
# PROFILES:
#   - oip-only:       Just the daemon (indexing, publishing, media)
#   - onion-press-server: OIP + WordPress + TOR anonymous publishing
#   - alexandria:     Full stack with AI/voice (CPU) - includes onion-press
#   - alexandria-gpu: Full stack with GPU acceleration
#   - alexandria-macMseries: Full stack for Apple Silicon
#   - alexandria-decentralized: Full stack + local Arweave gateway (CPU)
#   - alexandria-decentralized-gpu: Full stack + gateway (GPU)
#   - alexandria-decentralized-macMseries: Full stack + gateway (Apple Silicon)
#   - alexandria-noSTT: Alexandria without STT (for Mac/iOS clients)
#   - alexandria-noSTT-decentralized: noSTT + gateway
#   - chatterbox: Voice quality focus
#
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ════════════════════════════════════════════════════════════════════════════
  # INFRASTRUCTURE - Shared by all profiles
  # ════════════════════════════════════════════════════════════════════════════

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
      - xpack.security.enabled=false
      - logger.level=WARN
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ${ELASTICSEARCH_DATA_PATH:-./elasticsearch_data}:/usr/share/elasticsearch/data
    ports:
      - "${ELASTICSEARCH_PORT:-9200}:9200"
      - "${ELASTICSEARCH_TRANSPORT_PORT:-9300}:9300"
    networks:
      - oip-network
    restart: unless-stopped
    profiles:
      - oip-only
      - onion-press-server
      - alexandria
      - alexandria-gpu
      - alexandria-macMseries
      - alexandria-decentralized
      - alexandria-decentralized-gpu
      - alexandria-decentralized-macMseries
      - alexandria-noSTT
      - alexandria-noSTT-decentralized
      - chatterbox

  kibana:
    image: docker.elastic.co/kibana/kibana:8.17.0
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "${KIBANA_PORT:-5601}:5601"
    depends_on:
      - elasticsearch
    networks:
      - oip-network
    restart: unless-stopped
    profiles:
      - oip-only
      - onion-press-server
      - alexandria
      - alexandria-gpu
      - alexandria-macMseries
      - alexandria-decentralized
      - alexandria-decentralized-gpu
      - alexandria-decentralized-macMseries
      - chatterbox

  # ════════════════════════════════════════════════════════════════════════════
  # OIP DAEMON SERVICE - Library Infrastructure
  # ════════════════════════════════════════════════════════════════════════════

  oip-daemon-service:
    build:
      context: .
      dockerfile: Dockerfile.oip-daemon
    env_file:
      - .env
    ports:
      - "${PORT:-3005}:${PORT:-3005}"
      - "${DEBUG_PORT:-9229}:9229"
    environment:
      - NODE_ENV=production
      - PORT=${PORT:-3005}
      - ELASTICSEARCH_HOST=elasticsearch
      - ELASTICSEARCH_PORT=9200
      - GUN_PEERS=http://gun-relay:8765/gun
      - GUN_SYNC_ENABLED=${GUN_SYNC_ENABLED:-true}
      - IPFS_API_URL=http://ipfs:5001
      - JWT_SECRET=${JWT_SECRET}
      - ARWEAVE_KEY_FILE=${ARWEAVE_KEY_FILE}
      - TURBO_URL=${TURBO_URL:-https://turbo.ardrive.io}
      - USE_LOCAL_ARIO_GATEWAY=${USE_LOCAL_ARIO_GATEWAY:-false}
      - LOCAL_ARIO_GATEWAY_ADDRESS=${LOCAL_ARIO_GATEWAY_ADDRESS:-ario-gateway:4000}
      # Onion Press proxy configuration (for profiles that include onion-press-service)
      - ONION_PRESS_URL=http://onion-press-service:${ONION_PRESS_PORT:-3007}
      - ONION_PRESS_PORT=${ONION_PRESS_PORT:-3007}
      - ONION_PRESS_ENABLED=${ONION_PRESS_ENABLED:-true}
      # Alexandria proxy configuration (for profiles that include alexandria-service)
      - ALEXANDRIA_ENABLED=${ALEXANDRIA_ENABLED:-false}
      - ALEXANDRIA_URL=http://alexandria-service:${ALEXANDRIA_PORT:-3006}
      # Memory management - scheduled restart if threshold exceeded
      - MEMORY_RESTART_THRESHOLD_GB=${MEMORY_RESTART_THRESHOLD_GB:-36}
      - MEMORY_RESTART_TIME=${MEMORY_RESTART_TIME:-02:00}
      - MEMORY_RESTART_TIMEZONE=${MEMORY_RESTART_TIMEZONE:-America/Los_Angeles}
      - MEMORY_CLEANUP_INTERVAL_HOURS=${MEMORY_CLEANUP_INTERVAL_HOURS:-2}
      # V8 memory flags (max-old-space-size should be higher than MEMORY_RESTART_THRESHOLD_GB)
      # Note: --expose-gc and --optimize-for-size must be passed via CMD, not NODE_OPTIONS
      - NODE_OPTIONS=${NODE_OPTIONS:---max-old-space-size=49152}
    depends_on:
      - elasticsearch
      - gun-relay
    volumes:
      - ./data:/usr/src/app/data
      - ./wallets:/usr/src/app/wallets
      - ./public:/usr/src/app/public:ro
    networks:
      - oip-network
    restart: unless-stopped
    profiles:
      - oip-only
      - onion-press-server
      - alexandria
      - alexandria-gpu
      - alexandria-macMseries
      - alexandria-decentralized
      - alexandria-decentralized-gpu
      - alexandria-decentralized-macMseries
      - alexandria-noSTT
      - alexandria-noSTT-decentralized
      - chatterbox

  # GUN Relay - Private record storage
  gun-relay:
    image: node:18-alpine
    working_dir: /app
    command: sh -c "npm init -y >/dev/null 2>&1 && npm i gun && node gun-relay-server.js"
    ports:
      - "${GUN_RELAY_PORT:-8765}:8765"
    volumes:
      - gundata:/app/data
      - ./gun-relay-server.js:/app/gun-relay-server.js:ro
    environment:
      - GUN_PEERS=${GUN_EXTERNAL_PEERS:-}
      - GUN_ENV=production
      - GUN_SYNC_ENABLED=true
    networks:
      - oip-network
    restart: unless-stopped
    profiles:
      - oip-only
      - alexandria
      - alexandria-gpu
      - alexandria-macMseries
      - alexandria-decentralized
      - alexandria-decentralized-gpu
      - alexandria-decentralized-macMseries
      - alexandria-noSTT
      - alexandria-noSTT-decentralized
      - chatterbox

  # IPFS - Distributed file storage
  ipfs:
    image: ipfs/kubo:latest
    environment:
      - IPFS_PROFILE=server
    ports:
      - "${IPFS_API_PORT:-5001}:5001"
      - "${IPFS_GATEWAY_PORT:-8080}:8080"
    volumes:
      - ipfsdata:/data/ipfs
    networks:
      - oip-network
    restart: unless-stopped
    profiles:
      - oip-only
      - onion-press-server
      - alexandria
      - alexandria-gpu
      - alexandria-macMseries
      - alexandria-decentralized
      - alexandria-decentralized-gpu
      - alexandria-decentralized-macMseries
      - alexandria-noSTT
      - alexandria-noSTT-decentralized
      - chatterbox

  # ════════════════════════════════════════════════════════════════════════════
  # ONION PRESS SERVER SERVICES - Anonymous Publishing Platform
  # ════════════════════════════════════════════════════════════════════════════

  onion-press-service:
    build:
      context: .
      dockerfile: Dockerfile.onion-press
    env_file:
      - .env
    ports:
      - "${ONION_PRESS_PORT:-3007}:${ONION_PRESS_PORT:-3007}"
    environment:
      - NODE_ENV=production
      - PORT=${ONION_PRESS_PORT:-3007}
      - OIP_DAEMON_URL=http://oip-daemon-service:${OIP_DAEMON_PORT:-3005}
      - PUBLISH_TO_ARWEAVE=${PUBLISH_TO_ARWEAVE:-true}
      - PUBLISH_TO_GUN=${PUBLISH_TO_GUN:-true}
      - PUBLISH_TO_INTERNETARCHIVE=${PUBLISH_TO_INTERNETARCHIVE:-false}
      - GUN_EXTERNAL_PEERS=${GUN_EXTERNAL_PEERS:-}
      - GUN_SYNC_INTERVAL=${GUN_SYNC_INTERVAL:-30000}
      - GUN_SYNC_TRUSTED_NODES=${GUN_SYNC_TRUSTED_NODES:-}
      - TOR_PROXY_HOST=127.0.0.1
      - TOR_PROXY_PORT=9050
      - JWT_SECRET=${JWT_SECRET}
      - IA_ORGANIZATION_HANDLE=${IA_ORGANIZATION_HANDLE:-internetarchive}
    depends_on:
      oip-daemon-service:
        condition: service_healthy
    volumes:
      - ./data/onion-press:/usr/src/app/data
      - ./public/onion-press:/usr/src/app/public/onion-press
      - tor-hidden-service:/var/lib/tor/hidden_service
      - tor-data:/var/lib/tor/data
    networks:
      - oip-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:${ONION_PRESS_PORT:-3007}/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    profiles:
      - onion-press-server
      - alexandria-decentralized
      - alexandria-decentralized-gpu
      - alexandria-decentralized-macMseries
      - alexandria-noSTT-decentralized

  wordpress:
    build:
      context: .
      dockerfile: Dockerfile.wordpress
    ports:
      - "${WORDPRESS_PORT:-8080}:80"
    environment:
      - WORDPRESS_DB_HOST=wordpress-db
      - WORDPRESS_DB_USER=${WORDPRESS_DB_USER:-wordpress}
      - WORDPRESS_DB_PASSWORD=${WORDPRESS_DB_PASSWORD:-wordpress}
      - WORDPRESS_DB_NAME=${WORDPRESS_DB_NAME:-wordpress}
      # Critical: Tell WordPress its actual public URL (behind proxy)
      - WORDPRESS_CONFIG_EXTRA=define('WP_HOME', '${PUBLIC_API_BASE_URL:-http://localhost:3005}/wordpress'); define('WP_SITEURL', '${PUBLIC_API_BASE_URL:-http://localhost:3005}/wordpress'); define('FORCE_SSL_ADMIN', ${WORDPRESS_FORCE_SSL:-false});
      # Auto-installation settings (for anonymous deployment)
      - WP_AUTO_INSTALL=${WP_AUTO_INSTALL:-false}
      - WP_SITE_URL=${PUBLIC_API_BASE_URL:-http://localhost:3005}/wordpress
      - WP_SITE_TITLE=${WP_SITE_TITLE:-Onion Press}
      - WP_ADMIN_USER=${WP_ADMIN_USER:-admin}
      - WP_ADMIN_PASSWORD=${WP_ADMIN_PASSWORD:-}
      - WP_ADMIN_EMAIL=${WP_ADMIN_EMAIL:-noreply@localhost.invalid}
    depends_on:
      - wordpress-db
    volumes:
      - wordpress-data:/var/www/html
      - ./wordpress-plugin/op-publisher:/var/www/html/wp-content/plugins/op-publisher:ro
    networks:
      - oip-network
    restart: unless-stopped
    profiles:
      - onion-press-server
      - alexandria-decentralized
      - alexandria-decentralized-gpu
      - alexandria-decentralized-macMseries
      - alexandria-noSTT-decentralized

  wordpress-db:
    image: mariadb:latest
    environment:
      - MYSQL_ROOT_PASSWORD=${WORDPRESS_DB_ROOT_PASSWORD:-rootpassword}
      - MYSQL_DATABASE=${WORDPRESS_DB_NAME:-wordpress}
      - MYSQL_USER=${WORDPRESS_DB_USER:-wordpress}
      - MYSQL_PASSWORD=${WORDPRESS_DB_PASSWORD:-wordpress}
    volumes:
      - wordpress-db-data:/var/lib/mysql
    networks:
      - oip-network
    restart: unless-stopped
    profiles:
      - onion-press-server
      - alexandria-decentralized
      - alexandria-decentralized-gpu
      - alexandria-decentralized-macMseries
      - alexandria-noSTT-decentralized

  # ════════════════════════════════════════════════════════════════════════════
  # ALEXANDRIA SERVICE - The Librarian
  # ════════════════════════════════════════════════════════════════════════════

  alexandria-service:
    build:
      context: .
      dockerfile: Dockerfile.alexandria
    env_file:
      - .env
    ports:
      - "${ALEXANDRIA_PORT:-3006}:${ALEXANDRIA_PORT:-3006}"
    environment:
      - NODE_ENV=production
      - PORT=${ALEXANDRIA_PORT:-3006}
      - OIP_DAEMON_URL=http://oip-daemon-service:${OIP_DAEMON_PORT:-3005}
      - OLLAMA_HOST=http://ollama:11434
      - TTS_SERVICE_URL=http://tts-service:8005
      - STT_SERVICE_URL=http://stt-service:8003
      - JWT_SECRET=${JWT_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - XAI_API_KEY=${XAI_API_KEY:-}
    depends_on:
      oip-daemon-service:
        condition: service_healthy
      elasticsearch:
        condition: service_started
    volumes:
      - ./data:/usr/src/app/data
      - ./media:/usr/src/app/media
      - ./public:/usr/src/app/public:ro
    networks:
      - oip-network
    restart: unless-stopped
    profiles:
      - alexandria
      - alexandria-gpu
      - alexandria-macMseries
      - alexandria-decentralized
      - alexandria-decentralized-gpu
      - alexandria-decentralized-macMseries
      - alexandria-noSTT
      - alexandria-noSTT-decentralized

  # ════════════════════════════════════════════════════════════════════════════
  # AI SERVICES - Ollama (CPU variants)
  # ════════════════════════════════════════════════════════════════════════════

  ollama:
    image: ollama/ollama:latest
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      oip-network:
        aliases:
          - ollama
    restart: unless-stopped
    dns:
      - 8.8.8.8
      - 8.8.4.4
    profiles:
      - alexandria
      - alexandria-macMseries
      - alexandria-decentralized
      - alexandria-decentralized-macMseries
      - alexandria-noSTT
      - alexandria-noSTT-decentralized
      - chatterbox

  # Ollama with GPU support
  ollama-gpu:
    image: ollama/ollama:latest
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      oip-network:
        aliases:
          - ollama
    restart: unless-stopped
    dns:
      - 8.8.8.8
      - 8.8.4.4
    profiles:
      - alexandria-gpu
      - alexandria-decentralized-gpu
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # ════════════════════════════════════════════════════════════════════════════
  # VOICE SERVICES - TTS (Text-to-Speech)
  # ════════════════════════════════════════════════════════════════════════════

  tts-service:
    build:
      context: ./text-to-speech
    ports:
      - "${TTS_SERVICE_PORT:-8005}:8005"
    networks:
      oip-network:
        aliases:
          - tts-service
    restart: unless-stopped
    profiles:
      - alexandria
      - alexandria-macMseries
      - alexandria-decentralized
      - alexandria-decentralized-macMseries
      - alexandria-noSTT
      - alexandria-noSTT-decentralized
      - chatterbox

  tts-service-gpu:
    build:
      context: ./text-to-speech
      dockerfile: Dockerfile.gpu
    ports:
      - "${TTS_SERVICE_PORT:-8005}:8005"
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - TTS_GPU_ENABLED=true
    networks:
      oip-network:
        aliases:
          - tts-service
    restart: unless-stopped
    profiles:
      - alexandria-gpu
      - alexandria-decentralized-gpu
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # ════════════════════════════════════════════════════════════════════════════
  # VOICE SERVICES - STT (Speech-to-Text)
  # ════════════════════════════════════════════════════════════════════════════

  stt-service:
    build: ./speech-to-text
    environment:
      - WHISPER_MODEL=${WHISPER_MODEL:-base}
      - WHISPER_DEVICE=cpu
      - WHISPER_COMPUTE_TYPE=int8
    ports:
      - "${STT_SERVICE_PORT:-8003}:8003"
    volumes:
      - whisper-models:/app/models
    networks:
      oip-network:
        aliases:
          - stt-service
    restart: unless-stopped
    profiles:
      - alexandria
      - alexandria-macMseries
      - alexandria-decentralized
      - alexandria-decentralized-macMseries
      - chatterbox

  stt-service-gpu:
    build:
      context: ./speech-to-text
      dockerfile: Dockerfile.gpu
    environment:
      - WHISPER_MODEL=${WHISPER_MODEL:-base}
      - WHISPER_DEVICE=cuda
      - WHISPER_COMPUTE_TYPE=float16
      - CUDA_VISIBLE_DEVICES=0
    ports:
      - "${STT_SERVICE_PORT:-8003}:8003"
    volumes:
      - whisper-models:/app/models
    networks:
      oip-network:
        aliases:
          - stt-service
    restart: unless-stopped
    profiles:
      - alexandria-gpu
      - alexandria-decentralized-gpu
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # ════════════════════════════════════════════════════════════════════════════
  # DECENTRALIZED INFRASTRUCTURE - Local Arweave Gateway
  # ════════════════════════════════════════════════════════════════════════════

  ario-gateway:
    image: ghcr.io/ar-io/ar-io-core:latest
    env_file:
      - .env
    ports:
      - "${ARIO_GATEWAY_PORT:-4000}:4000"
    volumes:
      - ${ARIO_GATEWAY_DATA_PATH:-./ario_gateway_data}:/app/data
    environment:
      - PORT=4000
      - GRAPHQL_ENABLED=true
      - START_HEIGHT=${START_HEIGHT}
    networks:
      - oip-network
    restart: unless-stopped
    profiles:
      - alexandria-decentralized
      - alexandria-decentralized-gpu
      - alexandria-decentralized-macMseries
      - alexandria-noSTT-decentralized
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/ar-io/info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ════════════════════════════════════════════════════════════════════════════
  # NETWORK ACCESS - Ngrok
  # ════════════════════════════════════════════════════════════════════════════

  ngrok:
    image: ngrok/ngrok:latest
    command: http --domain=${NGROK_DOMAIN} oip-daemon-service:${PORT:-3005}
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTH_TOKEN}
    depends_on:
      - oip-daemon-service
    ports:
      - "${NGROK_DASHBOARD_PORT:-4040}:4040"
    networks:
      - oip-network
    restart: unless-stopped
    profiles:
      - oip-only
      - alexandria
      - alexandria-gpu
      - alexandria-macMseries
      - alexandria-decentralized
      - alexandria-decentralized-gpu
      - alexandria-decentralized-macMseries
      - alexandria-noSTT
      - alexandria-noSTT-decentralized
      - chatterbox

# ════════════════════════════════════════════════════════════════════════════
# VOLUMES
# ════════════════════════════════════════════════════════════════════════════

volumes:
  gundata:
    name: ${COMPOSE_PROJECT_NAME:-oip}_gundata
  ipfsdata:
    name: ${COMPOSE_PROJECT_NAME:-oip}_ipfsdata
  ollama-data:
    name: ${COMPOSE_PROJECT_NAME:-oip}_ollama-data
  whisper-models:
    name: ${COMPOSE_PROJECT_NAME:-oip}_whisper-models
  wordpress-data:
    name: ${COMPOSE_PROJECT_NAME:-oip}_wordpress-data
  wordpress-db-data:
    name: ${COMPOSE_PROJECT_NAME:-oip}_wordpress-db-data
  tor-hidden-service:
    name: ${COMPOSE_PROJECT_NAME:-oip}_tor-hidden-service
  tor-data:
    name: ${COMPOSE_PROJECT_NAME:-oip}_tor-data

# ════════════════════════════════════════════════════════════════════════════
# NETWORKS
# ════════════════════════════════════════════════════════════════════════════

networks:
  oip-network:
    name: ${COMPOSE_PROJECT_NAME:-oip}_oip-network
    driver: bridge


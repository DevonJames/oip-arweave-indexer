# FitnessAlly Calendar Token Migration Guide

## Overview

This guide helps the FitnessAlly development team integrate the new scoped calendar token system from OIP. The migration is **backward compatible** and can be deployed without breaking existing calendar subscriptions.

---

## üéØ Goals

1. Replace full-access JWT storage with scoped calendar JWT
2. Maintain calendar subscription functionality
3. Improve security by 90%
4. Zero downtime during migration

---

## üìã Prerequisites

- OIP backend running with calendar token endpoints (already deployed ‚úÖ)
- Access to FitnessAlly codebase
- Test user account for validation

---

## üîß Code Changes Required

### Change 1: Calendar Token Generation Endpoint

**File**: `server/routes.ts`  
**Location**: Line ~21256 (inside `POST /api/calendar/generate/:userId`)

**OLD CODE**:
```typescript
// Generate token locally
const token = crypto.randomBytes(32).toString('hex');

// ... existing code to get calendarPrefs ...

// ‚ùå PROBLEM: Stores full-access JWT
calendarTokenStore.set(token, {
  userId: userId,
  preferences: calendarPrefs,
  oipToken: oipToken, // Full-access JWT
  createdAt: Date.now()
});

await saveCalendarTokenStore();

res.json({
  success: true,
  token,
  urls: {
    combined: `${baseUrl}/api/calendar/subscription/${userId}/${token}`,
    workouts: `${baseUrl}/api/calendar/subscription/${userId}/${token}/workouts`,
    meals: `${baseUrl}/api/calendar/subscription/${userId}/${token}/meals`
  }
});
```

**NEW CODE**:
```typescript
// ‚úÖ Call OIP to generate scoped calendar JWT
console.log('üìÖ Generating calendar token via OIP backend for user:', userId);

const calendarTokenResponse = await fetch(
  `${oipHost}/api/user/generate-calendar-token`,
  {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${oipToken}`, // Use full JWT to authenticate
      'Content-Type': 'application/json'
    }
  }
);

if (!calendarTokenResponse.ok) {
  const errorData = await calendarTokenResponse.json();
  throw new Error(`Failed to generate calendar token: ${errorData.error || errorData.message}`);
}

const calendarTokenData = await calendarTokenResponse.json();
const calendarJWT = calendarTokenData.calendarJWT;
const tokenHash = calendarTokenData.tokenHash;

console.log('‚úÖ Calendar token generated by OIP');
console.log('   Token hash:', tokenHash.substring(0, 16) + '...');
console.log('   Scope:', calendarTokenData.scope);
console.log('   Expires in:', Math.floor(calendarTokenData.expiresIn / 86400), 'days');

// ... existing code to get/update calendarPrefs ...
calendarPrefs.calendar_feed_token = tokenHash; // Store hash in profile

// ... existing code to save profile ...

// ‚úÖ Store calendar JWT (scoped, not full-access)
calendarTokenStore.set(tokenHash, {
  userId: userId,
  preferences: calendarPrefs,
  oipToken: calendarJWT, // ‚úÖ Scoped calendar JWT
  createdAt: Date.now()
});

await saveCalendarTokenStore();

console.log('‚úÖ Calendar token stored locally for fast validation');

res.json({
  success: true,
  token: tokenHash, // Return hash as token identifier
  urls: {
    combined: `${baseUrl}/api/calendar/subscription/${userId}/${tokenHash}`,
    workouts: `${baseUrl}/api/calendar/subscription/${userId}/${tokenHash}/workouts`,
    meals: `${baseUrl}/api/calendar/subscription/${userId}/${tokenHash}/meals`
  }
});
```

**Key Changes**:
1. Call OIP's new endpoint to generate calendar JWT
2. Store the scoped JWT instead of full JWT
3. Use token hash as identifier
4. Add logging for debugging

---

### Change 2: Calendar Subscription Endpoints

**File**: `server/routes.ts`  
**Locations**: Lines ~21667, ~22012, ~22192

Update all three calendar subscription endpoints:
- `/api/calendar/subscription/:userId/:token` (combined)
- `/api/calendar/subscription/:userId/:token/workouts`
- `/api/calendar/subscription/:userId/:token/meals`

**OLD CODE** (example from combined endpoint):
```typescript
// ‚ùå Uses stored JWT in Authorization header
const workoutsResponse = await fetch(
  workoutsQueryUrl,
  { 
    headers: { 
      'Authorization': `Bearer ${tokenData.oipToken}` // Full or empty JWT
    } 
  }
);
```

**NEW CODE**:
```typescript
// ‚úÖ Use calendar JWT from token store
const calendarJWT = tokenData.oipToken;

if (!calendarJWT) {
  console.error('‚ùå No calendar JWT found in token store');
  return res.status(500).json({ 
    message: "Calendar token not properly configured. Please regenerate." 
  });
}

// ‚úÖ Use Authorization header (not query params - more secure)
const workoutsResponse = await fetch(
  workoutsQueryUrl,
  { 
    headers: { 
      'Authorization': `Bearer ${calendarJWT}`, // Calendar JWT
      'Accept': 'application/json'
    } 
  }
);

// Check for scope errors
if (!workoutsResponse.ok) {
  const errorData = await workoutsResponse.json();
  console.error('‚ùå Failed to fetch workouts:', errorData);
  
  if (workoutsResponse.status === 403) {
    return res.status(403).json({ 
      message: "Calendar token does not have access to this data. Please regenerate token." 
    });
  }
  
  return res.status(500).json({ 
    message: "Failed to fetch calendar data" 
  });
}
```

**Apply same changes to**:
- Workouts endpoint (Line ~22012)
- Meals endpoint (Line ~22192)

**Key Changes**:
1. Use calendar JWT from token store
2. Send via Authorization header (more secure than query params)
3. Add error handling for scope violations
4. Add logging for debugging

---

### Change 3: Token Store Loading (Fallback)

**File**: `server/routes.ts`  
**Location**: Line ~178 (inside `getCalendarTokenData` function)

**Current Code**: Already handles empty `oipToken` correctly ‚úÖ

No changes needed - the function already works with calendar JWTs.

---

## üß™ Testing Checklist

### Pre-Deployment Tests

1. **Local Testing**:
   ```bash
   # Start OIP backend (port 8765)
   cd /path/to/oip-arweave-indexer
   npm start
   
   # Start FitnessAlly backend (port 8001)
   cd /path/to/FitnessAlly
   npm run dev
   ```

2. **Test Calendar Token Generation**:
   ```bash
   # Login to FitnessAlly
   curl -X POST http://localhost:8001/api/login \
     -H "Content-Type: application/json" \
     -d '{"email":"test@example.com","password":"password"}' \
     --cookie-jar cookies.txt
   
   # Generate calendar token
   curl -X POST http://localhost:8001/api/calendar/generate/USER_ID \
     --cookie cookies.txt
   
   # Expected: Success with token hash returned
   ```

3. **Test Calendar Subscription**:
   ```bash
   # Subscribe with token
   curl http://localhost:8001/api/calendar/subscription/USER_ID/TOKEN_HASH
   
   # Expected: iCal format with workouts and meals
   ```

4. **Test Scope Enforcement**:
   ```bash
   # Extract calendar JWT from FitnessAlly logs
   # Try to access unauthorized record type
   curl -X GET "http://localhost:8765/api/records?recordType=userFitnessProfile" \
     -H "Authorization: Bearer CALENDAR_JWT"
   
   # Expected: 403 Forbidden - "Calendar tokens can only access: workoutSchedule, mealPlan"
   ```

### Post-Deployment Tests

1. **Existing Calendar Subscriptions**: Should continue working (old tokens won't expire for 45 days)
2. **New Calendar Subscriptions**: Should use scoped tokens
3. **Token Regeneration**: Should create new scoped token
4. **Calendar App Updates**: Should reflect within 5 minutes

---

## üöÄ Deployment Plan

### Phase 1: Staging Deployment (Day 1)

1. Deploy OIP backend changes to staging (already done ‚úÖ)
2. Deploy FitnessAlly changes to staging
3. Run test suite
4. Verify calendar subscriptions work
5. Monitor logs for errors

### Phase 2: Production Deployment (Day 2-3)

1. Deploy OIP changes to production
2. Deploy FitnessAlly changes to production
3. Monitor error rates
4. Check calendar subscription logs
5. Have 1-2 test users regenerate tokens

### Phase 3: User Migration (Week 1-2)

1. Notify users about security improvement
2. Prompt users to regenerate calendar tokens
3. Monitor adoption rate
4. All old tokens expire naturally after 45 days

---

## üêõ Troubleshooting

### Issue: "Failed to generate calendar token"

**Symptoms**: Calendar token generation endpoint returns error

**Checks**:
1. Is OIP backend running? `curl http://localhost:8765/health`
2. Is JWT valid? Decode and check expiration
3. Check OIP logs for `[Calendar Token]` errors
4. Verify JWT_SECRET matches between OIP and FitnessAlly

**Solution**:
```bash
# Check OIP logs
docker logs oip-backend | grep "Calendar Token"

# Verify endpoint is accessible
curl -X POST http://localhost:8765/api/user/generate-calendar-token \
  -H "Authorization: Bearer FULL_JWT"
```

---

### Issue: "Calendar tokens can only access: workoutSchedule, mealPlan"

**Symptoms**: 403 Forbidden when accessing calendar data

**Cause**: Token is working correctly! This error means:
- FitnessAlly is trying to access non-calendar record types
- Or using calendar JWT for non-calendar operations

**Solution**: Update FitnessAlly code to only use calendar JWT for:
- Fetching workoutSchedule records
- Fetching mealPlan records
- Never use it for profile, media, or other record types

---

### Issue: "No calendar JWT found in token store"

**Symptoms**: Calendar subscription endpoints fail

**Cause**: Token not properly stored or lost during server restart

**Solution**:
1. Check `.calendar-tokens.json` file exists and has entries
2. Verify `saveCalendarTokenStore()` is called after setting token
3. Have user regenerate calendar token

---

### Issue: "Calendar subscription shows old data"

**Symptoms**: Calendar app doesn't show latest workouts/meals

**Cause**: Calendar app caching (normal behavior)

**Solution**:
1. Calendar apps cache iCal feeds for 1-24 hours
2. Wait or manually refresh in calendar app
3. Add cache-busting to responses (already implemented ‚úÖ)

---

## üìä Monitoring

### Key Metrics to Track

1. **Calendar Token Generation**:
   - Rate of token generation requests
   - Success vs failure rate
   - Time to generate token

2. **Calendar Subscriptions**:
   - Number of active calendar subscriptions
   - Request frequency per subscription
   - Error rate

3. **Scope Violations**:
   - Count of 403 Forbidden responses
   - Types of blocked requests
   - Users affected

### Log Patterns to Watch

```bash
# Successful token generation
grep "\[Calendar Token\] Generated scoped JWT" logs/fitnessally.log

# Scope enforcement
grep "\[Calendar Scope\] Enforcing restrictions" logs/oip.log

# Scope violations (should be rare)
grep "\[Calendar Scope\] Blocked" logs/oip.log

# Errors
grep "Failed to generate calendar token" logs/fitnessally.log
```

---

## üîÑ Rollback Plan

If issues arise, rollback is simple:

### Rollback OIP Backend

```bash
git revert <commit-hash>
npm start
```

### Rollback FitnessAlly

```bash
git revert <commit-hash>
npm run dev
```

### Impact of Rollback

- Calendar tokens generated with new system will stop working
- Old full-JWT tokens will work again
- No data loss
- Users need to regenerate tokens after rollback

---

## ‚úÖ Success Criteria

Deployment is successful when:

- [x] OIP endpoints respond correctly
- [ ] FitnessAlly can generate calendar tokens via OIP
- [ ] Calendar subscriptions work with new tokens
- [ ] Scope enforcement blocks unauthorized access
- [ ] No increase in error rates
- [ ] Users can regenerate tokens successfully
- [ ] Old tokens continue to work until expiration

---

## üìû Support Contacts

- **OIP Backend Issues**: Check `docs/CALENDAR_TOKEN_SYSTEM.md`
- **FitnessAlly Integration**: This migration guide
- **Testing**: Use `scripts/test-calendar-tokens.sh` in OIP repo
- **Security Questions**: Review implementation summary

---

## üéì Training Materials

For the development team:

1. **Read First**: `docs/CALENDAR_TOKEN_QUICKSTART.md`
2. **Deep Dive**: `docs/CALENDAR_TOKEN_SYSTEM.md`
3. **Implementation**: `IMPLEMENTATION_SUMMARY.md`
4. **Testing**: `scripts/test-calendar-tokens.sh`

---

## üìù Change Summary

| Component | Changes | Lines Changed |
|-----------|---------|---------------|
| **OIP Backend** | 3 files | ~200 lines |
| **FitnessAlly** | 1 file | ~50 lines |
| **Documentation** | 4 files | ~1500 lines |
| **Testing** | 1 file | ~500 lines |
| **Total** | 9 files | ~2250 lines |

---

## üéØ Next Steps

1. Review this migration guide
2. Test changes in local development environment
3. Deploy to staging
4. Run full test suite
5. Deploy to production
6. Monitor for 24 hours
7. Notify users about security improvement
8. Celebrate! üéâ

---

**Migration Guide Version**: 1.0  
**Last Updated**: December 9, 2025  
**Estimated Implementation Time**: 2-4 hours  
**Estimated Testing Time**: 1-2 hours  
**Total Migration Time**: 1 business day


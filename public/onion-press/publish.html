<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§… Onion Press - Publisher</title>
    <link rel="stylesheet" href="/onion-press/css/onion-press.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- OIP v0.9 Crypto Dependencies (from CDN for browser) -->
    <script src="https://unpkg.com/@noble/hashes@1.3.3/sha256.js" type="module"></script>
    <script src="https://unpkg.com/@noble/curves@1.3.0/secp256k1.js" type="module"></script>
    <script src="https://unpkg.com/@scure/bip32@1.3.3/index.js" type="module"></script>
    <script src="https://unpkg.com/@scure/bip39@1.2.2/index.js" type="module"></script>
    
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           Publisher Page - Additional Styles
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        :root {
            --accent-purple: #7c3aed;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --font-mono: 'IBM Plex Mono', 'JetBrains Mono', monospace;
        }

        .publisher-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .publisher-header {
            text-align: center;
            margin-bottom: var(--spacing-2xl);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .publisher-header h1 {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
            background: linear-gradient(135deg, var(--accent-purple), #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .publisher-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .method-selection {
            margin-top: var(--spacing-xl);
        }

        .publishing-form {
            margin-top: var(--spacing-xl);
        }

        .back-button {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            margin-bottom: var(--spacing-lg);
            transition: var(--transition-fast);
        }

        .back-button:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        /* Identity Section */
        .identity-section {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .identity-section.active {
            border-color: var(--accent-green);
        }

        .identity-section h2 {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            font-size: 1.3rem;
        }

        .identity-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-purple);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .identity-section.active .identity-badge {
            background: var(--accent-green);
        }

        .mnemonic-input {
            width: 100%;
            min-height: 100px;
            padding: var(--spacing-md);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            font-family: var(--font-mono);
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            transition: var(--transition-normal);
        }

        .mnemonic-input:focus {
            outline: none;
            border-color: var(--accent-purple);
            border-style: solid;
        }

        .mnemonic-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .identity-info {
            margin-top: var(--spacing-lg);
            padding: var(--spacing-md);
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent-green);
            border-radius: var(--radius-md);
        }

        .identity-row {
            display: flex;
            align-items: baseline;
            gap: var(--spacing-md);
            padding: var(--spacing-xs) 0;
        }

        .identity-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 100px;
            font-size: 0.85rem;
        }

        .identity-value {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            word-break: break-all;
            color: var(--accent-green);
        }

        /* Record Form Section */
        .record-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .record-section h2 {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            font-size: 1.3rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            font-family: var(--font-sans);
            font-size: 1rem;
            transition: var(--transition-fast);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-purple);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Destinations Section */
        .destinations-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .destinations-section h2 {
            margin-bottom: var(--spacing-lg);
        }

        .destination-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .destination-card {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .destination-card:hover {
            border-color: var(--accent-purple);
        }

        .destination-card.selected {
            border-color: var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .destination-card input {
            width: 20px;
            height: 20px;
        }

        .destination-icon {
            font-size: 1.5rem;
        }

        .destination-info h4 {
            margin: 0;
            font-size: 1rem;
        }

        .destination-info p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Publish Button */
        .publish-actions {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .publish-btn {
            padding: var(--spacing-md) var(--spacing-2xl);
            font-size: 1.2rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .publish-btn.primary {
            background: var(--accent-purple);
            color: white;
        }

        .publish-btn.primary:hover:not(:disabled) {
            background: #6d28d9;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
        }

        .publish-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Status Messages */
        .status-message {
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-xl);
            display: none;
        }

        .status-message.visible {
            display: block;
        }

        .status-message.success {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
        }

        .status-message.processing {
            background: rgba(124, 58, 237, 0.15);
            border: 1px solid var(--accent-purple);
            color: var(--accent-purple);
        }

        .status-message h3 {
            margin-bottom: var(--spacing-sm);
        }

        .status-message .tx-link {
            font-family: var(--font-mono);
            word-break: break-all;
        }

        .status-message a {
            color: inherit;
            text-decoration: underline;
        }

        /* Warning Box */
        .warning-box {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid var(--accent-orange);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            font-size: 0.9rem;
            color: var(--accent-orange);
        }

        .warning-box strong {
            display: block;
            margin-bottom: var(--spacing-xs);
        }

        .info-box {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid #3b82f6;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            font-size: 0.9rem;
            color: #3b82f6;
        }

        .info-box strong {
            display: block;
            margin-bottom: var(--spacing-xs);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .destination-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">ğŸ§…</span>
                <span class="logo-text">Onion Press</span>
            </div>
            <nav class="nav">
                <a href="/onion-press/" class="nav-btn">â† Back to Browse</a>
                <a href="/debug/v09" class="nav-btn">ğŸ” Debug Interface</a>
            </nav>
            <div class="header-actions">
                <div class="tor-status" id="torStatus" title="TOR Status">
                    <span class="tor-indicator"></span>
                    <span class="tor-label">TOR</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="publisher-container">
            <div class="publisher-header">
                <h1 id="publisherTitle">ğŸ” Publisher</h1>
                <p id="publisherDescription">Choose your publishing method below.</p>
            </div>
            
            <!-- Method Selection (shown initially) -->
            <div id="methodSelection" class="method-selection">
                <div class="publishing-methods">
                    <div class="publishing-method-card" onclick="selectMethod('did')">
                        <div class="method-header">
                            <span class="method-icon">ğŸ”‘</span>
                            <h3>Decentralized ID</h3>
                        </div>
                        <p class="method-description">
                            Uses the <a href="https://www.w3.org/TR/did/" target="_blank" class="method-link">DID spec</a> for completely login-less publishing with client-side mnemonic signing. If you wish to create a provable relationship between all of your posts, this is the method you'll want to use. Just save the mnemonic that is generated the first time you post and use it again in future posts to create a cryptographic connection between your posts.
                        </p>
                        <button class="method-action-btn" onclick="selectMethod('did')">Publish with DID â†’</button>
                    </div>
                    
                    <div class="publishing-method-card" onclick="selectMethod('account')">
                        <div class="method-header">
                            <span class="method-icon">ğŸ”</span>
                            <h3>Account</h3>
                        </div>
                        <p class="method-description">
                            Use your server account to publish. Posts will be identified by your account name. When Arweave is enabled, records are signed with both your account wallet and the server's creator key.
                        </p>
                        <button class="method-action-btn" onclick="selectMethod('account')">Publish with Account â†’</button>
                    </div>
                    
                    <div class="publishing-method-card" onclick="selectMethod('anonymous')">
                        <div class="method-header">
                            <span class="method-icon">ğŸ”’</span>
                            <h3>Anonymous</h3>
                        </div>
                        <p class="method-description">
                            No account, no signatures, totally anonymous. Only downside is that there will be no relationship between your posts, so any trust you establish from one post cannot be leveraged in others.
                        </p>
                        <button class="method-action-btn" onclick="selectMethod('anonymous')">Publish Anonymously â†’</button>
                    </div>
                </div>
            </div>
            
            <!-- DID Publishing Form (hidden initially) -->
            <div id="didForm" class="publishing-form hidden">
                <button class="back-button" onclick="showMethodSelection()">â† Back to Methods</button>
                
                <!-- Step 1: Identity -->
                <section class="identity-section" id="identitySection">
                    <h2><span class="identity-badge">1</span> Your Identity</h2>
                    
                    <div class="warning-box">
                        <strong>âš ï¸ Security Warning</strong>
                        Your mnemonic is your identity and signing key. It is processed entirely in your browser and never sent to any server. 
                        However, only use this for testing or content you're comfortable having publicly attributed to this identity.
                    </div>

                    <div class="form-group">
                        <label for="mnemonic">BIP-39 Mnemonic (12 or 24 words)</label>
                        <textarea id="mnemonic" class="mnemonic-input" 
                            placeholder="Enter your mnemonic phrase here, or click 'Generate Test Mnemonic' below..."></textarea>
                    </div>

                    <div class="mnemonic-actions">
                        <button id="generateMnemonicBtn" class="secondary-btn">ğŸ² Generate Test Mnemonic</button>
                        <button id="loadIdentityBtn" class="primary-btn">ğŸ”‘ Load Identity</button>
                    </div>

                    <div id="identityInfo" class="identity-info hidden">
                        <div class="identity-row">
                            <span class="identity-label">Your DID</span>
                            <span class="identity-value" id="displayDid">-</span>
                        </div>
                        <div class="identity-row">
                            <span class="identity-label">Signing xpub</span>
                            <span class="identity-value" id="displayXpub">-</span>
                        </div>
                        <div class="identity-row">
                            <span class="identity-label">Status</span>
                            <span class="identity-value" style="color: var(--accent-green);">âœ“ Ready to sign records</span>
                        </div>
                    </div>
                </section>

                <!-- Step 2: Record -->
                <section class="record-section">
                    <h2><span class="identity-badge" style="background: var(--accent-orange);">2</span> Create Record</h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="recordType">Record Type</label>
                            <select id="recordType">
                                <option value="post">ğŸ“° Post / Article</option>
                                <option value="image">ğŸ–¼ï¸ Image</option>
                                <option value="video">ğŸ¬ Video</option>
                                <option value="audio">ğŸµ Audio</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="byline">Byline / Author Name</label>
                            <input type="text" id="byline" placeholder="Anonymous">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" placeholder="Enter a title for your record..." required>
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" rows="2" placeholder="Brief description of your content..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="content">Content *</label>
                        <textarea id="content" rows="8" placeholder="The main content of your record..." required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="webUrl">Web URL (canonical link)</label>
                            <input type="url" id="webUrl" placeholder="https://example.com/original-post">
                        </div>
                        <div class="form-group">
                            <label for="tags">Tags (comma-separated)</label>
                            <input type="text" id="tags" placeholder="news, politics, whistleblower">
                        </div>
                    </div>
                </section>

                <!-- Step 3: Destinations -->
                <section class="destinations-section">
                    <h2><span class="identity-badge" style="background: #06b6d4;">3</span> Publishing Destinations</h2>

                    <div class="destination-grid">
                        <label class="destination-card selected">
                            <input type="checkbox" id="destArweave" checked>
                            <span class="destination-icon">â›“ï¸</span>
                            <div class="destination-info">
                                <h4>Arweave</h4>
                                <p>Permanent blockchain storage</p>
                            </div>
                        </label>

                        <label class="destination-card">
                            <input type="checkbox" id="destGun">
                            <span class="destination-icon">ğŸ”„</span>
                            <div class="destination-info">
                                <h4>GUN Network</h4>
                                <p>Real-time peer sync</p>
                            </div>
                        </label>

                        <label class="destination-card">
                            <input type="checkbox" id="destThisHost">
                            <span class="destination-icon">ğŸ </span>
                            <div class="destination-info">
                                <h4 id="thisHostName">This Host</h4>
                                <p id="thisHostUrl">Loading...</p>
                            </div>
                        </label>
                    </div>
                </section>

                <!-- Publish Button -->
                <div class="publish-actions">
                    <button id="publishBtn" class="publish-btn primary" disabled>
                        ğŸš€ Sign & Publish Record
                    </button>
                </div>
            </div>
            
            <!-- Account Publishing Form (hidden initially) -->
            <div id="accountForm" class="publishing-form hidden">
                <button class="back-button" onclick="showMethodSelection()">â† Back to Methods</button>
                
                <h2>ğŸ” Account-Based Publishing</h2>
                <p class="form-description">
                    Use your server account to publish. You'll need to log in first.
                </p>
                
                <!-- Login Section -->
                <div id="accountLoginSection" class="form-section">
                    <h3>Login Required</h3>
                    <p>You need to be logged in to use account-based publishing.</p>
                    <div class="form-group">
                        <label for="accountEmail">Email:</label>
                        <input type="email" id="accountEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="accountPassword">Password:</label>
                        <input type="password" id="accountPassword" placeholder="Your password" required>
                    </div>
                    <button class="submit-btn" onclick="accountLogin()">Login</button>
                    <p class="form-note">Don't have an account? <a href="/onion-press/" onclick="alert('Please register through the main interface first')">Register here</a></p>
                </div>
                
                <!-- Publishing Form (shown after login) -->
                <div id="accountPublishSection" class="form-section hidden">
                    <h3>Create Post</h3>
                    <div class="form-group">
                        <label for="accountTitle">Title:</label>
                        <input type="text" id="accountTitle" placeholder="Post title" required>
                    </div>
                    <div class="form-group">
                        <label for="accountContent">Content:</label>
                        <textarea id="accountContent" rows="10" placeholder="Your post content..." required></textarea>
                    </div>
                    
                    <!-- Destination Selection -->
                    <div class="form-group">
                        <label>Publish To:</label>
                        <div class="destination-grid">
                            <label class="destination-checkbox">
                                <input type="checkbox" id="accountDestArweave" checked>
                                <span>Arweave</span>
                            </label>
                            <label class="destination-checkbox">
                                <input type="checkbox" id="accountDestGun">
                                <span>GUN</span>
                            </label>
                            <label class="destination-checkbox">
                                <input type="checkbox" id="accountDestThisHost">
                                <span>This Host</span>
                            </label>
                        </div>
                    </div>
                    
                    <button class="submit-btn" onclick="publishAccount()">Publish</button>
                    <div id="accountStatus" class="status-message"></div>
                </div>
            </div>
            
            <!-- Anonymous Publishing Form (hidden initially) -->
            <div id="anonymousForm" class="publishing-form hidden">
                <button class="back-button" onclick="showMethodSelection()">â† Back to Methods</button>
                
                <div class="info-box">
                    <strong>â„¹ï¸ Anonymous Publishing</strong>
                    This method publishes without any cryptographic signatures. Your posts will be completely anonymous with no way to prove authorship or link posts together. Perfect for whistleblowing or completely anonymous publishing.
                </div>
                
                <!-- Step 1: Record -->
                <section class="record-section">
                    <h2><span class="identity-badge" style="background: var(--accent-orange);">1</span> Create Record</h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="anonRecordType">Record Type</label>
                            <select id="anonRecordType">
                                <option value="post">ğŸ“° Post / Article</option>
                                <option value="image">ğŸ–¼ï¸ Image</option>
                                <option value="video">ğŸ¬ Video</option>
                                <option value="audio">ğŸµ Audio</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="anonByline">Byline / Author Name</label>
                            <input type="text" id="anonByline" placeholder="Anonymous">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="anonTitle">Title *</label>
                        <input type="text" id="anonTitle" placeholder="Enter a title for your record..." required>
                    </div>

                    <div class="form-group">
                        <label for="anonDescription">Description</label>
                        <textarea id="anonDescription" rows="2" placeholder="Brief description of your content..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="anonContent">Content *</label>
                        <textarea id="anonContent" rows="8" placeholder="The main content of your record..." required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="anonWebUrl">Web URL (canonical link)</label>
                            <input type="url" id="anonWebUrl" placeholder="https://example.com/original-post">
                        </div>
                        <div class="form-group">
                            <label for="anonTags">Tags (comma-separated)</label>
                            <input type="text" id="anonTags" placeholder="news, politics, whistleblower">
                        </div>
                    </div>
                </section>

                <!-- Step 2: Destinations (Admin Only) -->
                <section class="destinations-section admin-only hidden" id="anonDestinationsSection">
                    <h2><span class="identity-badge" style="background: #06b6d4;">2</span> Publishing Destinations</h2>

                    <div class="destination-grid">
                        <label class="destination-card selected">
                            <input type="checkbox" id="anonDestArweave" checked>
                            <span class="destination-icon">â›“ï¸</span>
                            <div class="destination-info">
                                <h4>Arweave</h4>
                                <p>Permanent blockchain storage</p>
                            </div>
                        </label>

                        <label class="destination-card">
                            <input type="checkbox" id="anonDestGun">
                            <span class="destination-icon">ğŸ”„</span>
                            <div class="destination-info">
                                <h4>GUN Network</h4>
                                <p>Real-time peer sync</p>
                            </div>
                        </label>

                        <label class="destination-card">
                            <input type="checkbox" id="anonDestThisHost">
                            <span class="destination-icon">ğŸ </span>
                            <div class="destination-info">
                                <h4 id="anonThisHostName">This Host</h4>
                                <p id="anonThisHostUrl">Loading...</p>
                            </div>
                        </label>
                    </div>
                </section>

                <!-- Publish Button -->
                <div class="publish-actions">
                    <button id="anonPublishBtn" class="publish-btn primary">
                        ğŸš€ Publish Anonymously
                    </button>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="status-message"></div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <span>OIP v0.9 Publisher</span>
            <span class="separator">|</span>
            <span>Powered by <a href="https://oip.io" target="_blank">Open Index Protocol</a></span>
        </div>
    </footer>

    <script type="module">
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // OIP v0.9 Publisher - DID and Anonymous Publishing
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Import crypto libraries (only needed for DID mode)
        import { HDKey } from 'https://esm.sh/@scure/bip32@1.3.3';
        import { mnemonicToSeedSync, validateMnemonic, generateMnemonic } from 'https://esm.sh/@scure/bip39@1.2.2';
        import { wordlist } from 'https://esm.sh/@scure/bip39@1.2.2/wordlists/english';
        import { sha256 } from 'https://esm.sh/@noble/hashes@1.3.3/sha256';
        import { secp256k1 } from 'https://esm.sh/@noble/curves@1.3.0/secp256k1';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONSTANTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const OIP_PURPOSE = 176800;
        const OIP_VERSION = '0.9.0';

        // State
        let identity = null;
        let currentMethod = null;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // METHOD SELECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Account state
        let accountToken = localStorage.getItem('onionpress_token');
        let accountUser = null;

        function selectMethod(method) {
            currentMethod = method;
            const methodSelection = document.getElementById('methodSelection');
            const didForm = document.getElementById('didForm');
            const anonymousForm = document.getElementById('anonymousForm');
            const accountForm = document.getElementById('accountForm');
            const title = document.getElementById('publisherTitle');
            const description = document.getElementById('publisherDescription');
            
            methodSelection.classList.add('hidden');
            
            if (method === 'did') {
                didForm.classList.remove('hidden');
                anonymousForm.classList.add('hidden');
                accountForm.classList.add('hidden');
                title.textContent = 'ğŸ”‘ Publish with DID';
                description.textContent = 'Create a provable cryptographic identity for your posts.';
            } else if (method === 'anonymous') {
                didForm.classList.add('hidden');
                anonymousForm.classList.remove('hidden');
                accountForm.classList.add('hidden');
                title.textContent = 'ğŸ”’ Anonymous Publisher';
                description.textContent = 'Publish completely anonymously with no signatures or identity.';
            } else if (method === 'account') {
                didForm.classList.add('hidden');
                anonymousForm.classList.add('hidden');
                accountForm.classList.remove('hidden');
                title.textContent = 'ğŸ” Account-Based Publishing';
                description.textContent = 'Publish using your server account.';
                
                // Check if already logged in
                if (accountToken) {
                    checkAccountLogin();
                }
            }
        }

        function showMethodSelection() {
            currentMethod = null;
            const methodSelection = document.getElementById('methodSelection');
            const didForm = document.getElementById('didForm');
            const anonymousForm = document.getElementById('anonymousForm');
            const accountForm = document.getElementById('accountForm');
            const title = document.getElementById('publisherTitle');
            const description = document.getElementById('publisherDescription');
            
            methodSelection.classList.remove('hidden');
            didForm.classList.add('hidden');
            anonymousForm.classList.add('hidden');
            accountForm.classList.add('hidden');
            title.textContent = 'ğŸ” Publisher';
            description.textContent = 'Choose your publishing method below.';
        }

        // Check URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const methodParam = urlParams.get('method');
        if (methodParam === 'did' || methodParam === 'anonymous' || methodParam === 'account') {
            selectMethod(methodParam);
        }
        
        // Account login functions
        async function accountLogin() {
            const email = document.getElementById('accountEmail').value;
            const password = document.getElementById('accountPassword').value;
            const statusDiv = document.getElementById('accountStatus');
            
            if (!email || !password) {
                statusDiv.textContent = 'Please enter email and password';
                statusDiv.className = 'status-message error';
                return;
            }
            
            try {
                statusDiv.textContent = 'Logging in...';
                statusDiv.className = 'status-message info';
                
                const response = await fetch('/api/user/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success && data.token) {
                    accountToken = data.token;
                    accountUser = { email, publicKey: data.publicKey };
                    localStorage.setItem('onionpress_token', accountToken);
                    
                    // Show publish form
                    document.getElementById('accountLoginSection').classList.add('hidden');
                    document.getElementById('accountPublishSection').classList.remove('hidden');
                    
                    statusDiv.textContent = 'Login successful!';
                    statusDiv.className = 'status-message success';
                } else {
                    throw new Error(data.error || 'Login failed');
                }
            } catch (error) {
                statusDiv.textContent = `Login failed: ${error.message}`;
                statusDiv.className = 'status-message error';
            }
        }
        
        async function checkAccountLogin() {
            if (!accountToken) return;
            
            try {
                // Verify token is still valid by checking user info
                const response = await fetch('/api/user/mnemonic', {
                    headers: { 'Authorization': `Bearer ${accountToken}` }
                });
                
                if (response.ok) {
                    // Token is valid, show publish form
                    document.getElementById('accountLoginSection').classList.add('hidden');
                    document.getElementById('accountPublishSection').classList.remove('hidden');
                } else {
                    // Token invalid, clear it
                    accountToken = null;
                    localStorage.removeItem('onionpress_token');
                }
            } catch (error) {
                // Token invalid
                accountToken = null;
                localStorage.removeItem('onionpress_token');
            }
        }
        
        async function publishAccount() {
            const title = document.getElementById('accountTitle').value;
            const content = document.getElementById('accountContent').value;
            const password = document.getElementById('accountPassword').value;
            const statusDiv = document.getElementById('accountStatus');
            
            if (!title || !content) {
                statusDiv.textContent = 'Please fill in title and content';
                statusDiv.className = 'status-message error';
                return;
            }
            
            if (!accountToken) {
                statusDiv.textContent = 'Please login first';
                statusDiv.className = 'status-message error';
                return;
            }
            
            if (!password) {
                statusDiv.textContent = 'Password required for signing';
                statusDiv.className = 'status-message error';
                return;
            }
            
            try {
                statusDiv.textContent = 'Publishing...';
                statusDiv.className = 'status-message info';
                
                // Build payload
                const payload = {
                    '@context': 'temp',
                    tags: [
                        { name: 'Index-Method', value: 'OIP' },
                        { name: 'Ver', value: '0.9.0' },
                        { name: 'Content-Type', value: 'application/json' }
                    ],
                    fragments: [{
                        id: crypto.randomUUID(),
                        dataType: 'Record',
                        recordType: 'post',
                        records: [{
                            basic: {
                                name: title,
                                description: content.substring(0, 200)
                            },
                            post: {
                                articleText: content,
                                byline: accountUser?.email || 'Account User'
                            }
                        }]
                    }]
                };
                
                // Get destinations
                const destinations = {
                    arweave: document.getElementById('accountDestArweave').checked,
                    gun: document.getElementById('accountDestGun').checked,
                    thisHost: document.getElementById('accountDestThisHost').checked
                };
                
                // Publish
                const response = await fetch('/onion-press/api/records/publishAccount', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accountToken}`
                    },
                    body: JSON.stringify({ payload, destinations, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.innerHTML = `
                        <div class="success">
                            <strong>âœ… Published successfully!</strong><br>
                            ${data.transactionId ? `Arweave TX: ${data.transactionId}<br>` : ''}
                            ${data.destinations?.thisHost?.postId ? `WordPress Post ID: ${data.destinations.thisHost.postId}<br>` : ''}
                            <a href="/onion-press/" class="link">View in Browse â†’</a>
                        </div>
                    `;
                    statusDiv.className = 'status-message success';
                    
                    // Clear form
                    document.getElementById('accountTitle').value = '';
                    document.getElementById('accountContent').value = '';
                } else {
                    throw new Error(data.error || 'Publishing failed');
                }
            } catch (error) {
                statusDiv.textContent = `Publishing failed: ${error.message}`;
                statusDiv.className = 'status-message error';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UTILITY FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function base64urlEncode(bytes) {
            const arr = bytes instanceof Uint8Array ? bytes : new Uint8Array(bytes);
            const base64 = btoa(String.fromCharCode(...arr));
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        function canonicalJson(obj) {
            return JSON.stringify(obj, (key, value) => {
                if (value && typeof value === 'object' && !Array.isArray(value)) {
                    return Object.keys(value).sort().reduce((sorted, k) => {
                        sorted[k] = value[k];
                        return sorted;
                    }, {});
                }
                return value;
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // IDENTITY MANAGEMENT (DID mode only)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function createIdentity(mnemonic, account = 0) {
            // Validate mnemonic
            if (!validateMnemonic(mnemonic, wordlist)) {
                throw new Error('Invalid mnemonic phrase. Please enter a valid BIP-39 mnemonic.');
            }

            // Generate seed and master key
            const seed = mnemonicToSeedSync(mnemonic);
            const masterKey = HDKey.fromMasterSeed(seed);

            // Derive signing key at m/176800'/0'/account'
            const signingPath = `m/${OIP_PURPOSE}'/0'/${account}'`;
            const signingKey = masterKey.derive(signingPath);

            // Generate DID from master public key
            const pubKeyHash = sha256(masterKey.publicKey);
            const did = `did:arweave:${base64urlEncode(pubKeyHash)}`;

            return {
                did,
                signingXpub: signingKey.publicExtendedKey,
                signingKey: signingKey,
                account
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SIGNING (DID mode only)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function signPayload(payload, identity) {
            // 1. Compute payload digest (canonical JSON â†’ SHA256 â†’ base64url)
            const payloadBytes = canonicalJson(payload);
            const payloadHash = sha256(new TextEncoder().encode(payloadBytes));
            const payloadDigest = base64urlEncode(payloadHash);

            // 2. Derive key index from payload digest
            const indexInput = `oip:${payloadDigest}`;
            const indexHash = sha256(new TextEncoder().encode(indexInput));
            const view = new DataView(indexHash.buffer);
            const keyIndex = view.getUint32(0, false) & 0x7FFFFFFF;

            // 3. Derive child signing key
            const childKey = identity.signingKey.deriveChild(keyIndex);

            // 4. Sign the payload hash
            const signature = secp256k1.sign(payloadHash, childKey.privateKey);
            const signatureBase64 = base64urlEncode(signature.toCompactRawBytes());

            // 5. Add signature tags to payload
            const signedPayload = JSON.parse(JSON.stringify(payload));
            signedPayload.tags.push({ name: 'PayloadDigest', value: payloadDigest });
            signedPayload.tags.push({ name: 'KeyIndex', value: keyIndex.toString() });
            signedPayload.tags.push({ name: 'CreatorSig', value: signatureBase64 });

            return {
                signedPayload,
                debug: {
                    payloadDigest,
                    keyIndex,
                    signature: signatureBase64
                }
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RECORD BUILDING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function buildRecord(method = 'did') {
            const isDid = method === 'did';
            const recordType = isDid ? document.getElementById('recordType').value : document.getElementById('anonRecordType').value;
            const title = isDid ? document.getElementById('title').value.trim() : document.getElementById('anonTitle').value.trim();
            const description = isDid ? document.getElementById('description').value.trim() : document.getElementById('anonDescription').value.trim();
            const content = isDid ? document.getElementById('content').value.trim() : document.getElementById('anonContent').value.trim();
            const byline = isDid ? (document.getElementById('byline').value.trim() || 'Anonymous') : (document.getElementById('anonByline').value.trim() || 'Anonymous');
            const webUrl = isDid ? document.getElementById('webUrl').value.trim() : document.getElementById('anonWebUrl').value.trim();
            const tags = isDid ? document.getElementById('tags').value.trim() : document.getElementById('anonTags').value.trim();

            if (!title) throw new Error('Title is required');
            if (!content) throw new Error('Content is required');

            // Build the record data
            const recordData = {
                basic: {
                    name: title,
                    description: description || undefined
                }
            };

            // Add type-specific fields
            if (recordType === 'post') {
                recordData.post = {
                    byline: byline,
                    articleText: content,
                    webUrl: webUrl || undefined
                };
            } else if (recordType === 'image') {
                recordData.image = {
                    description: content
                };
            } else if (recordType === 'video') {
                recordData.video = {
                    description: content
                };
            } else if (recordType === 'audio') {
                recordData.audio = {
                    description: content
                };
            }

            // Build tags array for Arweave
            const tagsList = tags ? tags.split(',').map(t => t.trim()).filter(t => t) : [];

            if (isDid && identity) {
                // DID mode: Build signed payload
                const payload = {
                    '@context': identity.did,
                    tags: [
                        { name: 'Index-Method', value: 'OIP' },
                        { name: 'Ver', value: OIP_VERSION },
                        { name: 'Content-Type', value: 'application/json' },
                        { name: 'Creator', value: identity.did },
                        { name: 'Record-Type', value: recordType }
                    ],
                    fragments: [{
                        id: crypto.randomUUID(),
                        dataType: 'Record',
                        recordType: recordType,
                        records: [recordData]
                    }]
                };

                // Add content tags
                if (tagsList.length > 0) {
                    payload.tags.push({ name: 'Tags', value: tagsList.join(',') });
                }

                return { payload, method: 'did' };
            } else {
                // Anonymous mode: Build unsigned payload
                const payload = {
                    tags: [
                        { name: 'Index-Method', value: 'OIP' },
                        { name: 'Ver', value: OIP_VERSION },
                        { name: 'Content-Type', value: 'application/json' },
                        { name: 'Record-Type', value: recordType },
                        { name: 'Anonymous', value: 'true' }
                    ],
                    fragments: [{
                        id: crypto.randomUUID(),
                        dataType: 'Record',
                        recordType: recordType,
                        records: [recordData]
                    }]
                };

                // Add content tags
                if (tagsList.length > 0) {
                    payload.tags.push({ name: 'Tags', value: tagsList.join(',') });
                }

                return { payload, method: 'anonymous' };
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PUBLISHING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function publishRecord() {
            const statusEl = document.getElementById('statusMessage');
            const publishBtn = document.getElementById('publishBtn');

            try {
                publishBtn.disabled = true;
                showStatus('processing', 'â³ Signing and publishing...', 'Please wait while your record is signed and submitted to the blockchain.');

                // Build the record
                const { payload, method } = buildRecord('did');
                console.log('Built payload:', payload);

                // Sign it client-side
                const { signedPayload, debug } = signPayload(payload, identity);
                console.log('Signed payload:', signedPayload);
                console.log('Debug info:', debug);

                // Get selected destinations
                const destinations = {
                    arweave: document.getElementById('destArweave').checked,
                    gun: document.getElementById('destGun').checked,
                    thisHost: document.getElementById('destThisHost').checked
                };

                // Send to server (server pays Arweave fee)
                const response = await fetch('/onion-press/api/records/publishSigned', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        payload: signedPayload,
                        verifySignature: false, // Skip verification for new creators
                        destinations
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || result.error || 'Publishing failed');
                }

                // Build success message based on destinations
                let successMessage = '<p>Your record has been published!</p>';
                
                if (result.destinations?.arweave?.success) {
                    successMessage += `
                        <p><strong>âœ… Arweave:</strong> Published</p>
                        <p><strong>Transaction ID:</strong> <span class="tx-link">${result.transactionId}</span></p>
                        <p><strong>DID:</strong> <span class="tx-link">${result.did}</span></p>
                        <p><a href="${result.explorerUrl}" target="_blank">View on Arweave Explorer â†’</a></p>
                    `;
                } else if (result.destinations?.arweave) {
                    successMessage += `<p><strong>âŒ Arweave:</strong> ${result.destinations.arweave.error || 'Failed'}</p>`;
                }
                
                if (result.destinations?.thisHost?.success) {
                    successMessage += `
                        <p><strong>âœ… WordPress:</strong> Published</p>
                        <p><strong>Post ID:</strong> ${result.destinations.thisHost.postId}</p>
                        <p><a href="${result.destinations.thisHost.permalink}" target="_blank">View WordPress Post â†’</a></p>
                    `;
                } else if (result.destinations?.thisHost) {
                    successMessage += `<p><strong>âŒ WordPress:</strong> ${result.destinations.thisHost.error || 'Failed'}</p>`;
                }
                
                showStatus('success', 'âœ… Published Successfully!', successMessage);

                // Clear form
                document.getElementById('title').value = '';
                document.getElementById('description').value = '';
                document.getElementById('content').value = '';
                document.getElementById('webUrl').value = '';
                document.getElementById('tags').value = '';

            } catch (error) {
                console.error('Publish error:', error);
                showStatus('error', 'âŒ Publishing Failed', error.message);
            } finally {
                publishBtn.disabled = false;
            }
        }

        async function publishAnonymous() {
            const statusEl = document.getElementById('statusMessage');
            const publishBtn = document.getElementById('anonPublishBtn');

            try {
                publishBtn.disabled = true;
                showStatus('processing', 'â³ Publishing anonymously...', 'Please wait while your record is submitted.');

                // Build the record (unsigned)
                const { payload } = buildRecord('anonymous');
                console.log('Built anonymous payload:', payload);

                // Get selected destinations (use defaults if admin section is hidden)
                const destinationsSection = document.getElementById('anonDestinationsSection');
                let destinations;
                
                if (destinationsSection && !destinationsSection.classList.contains('hidden')) {
                    // Admin mode: use selected destinations
                    destinations = {
                        arweave: document.getElementById('anonDestArweave')?.checked || false,
                        gun: document.getElementById('anonDestGun')?.checked || false,
                        thisHost: document.getElementById('anonDestThisHost')?.checked || false
                    };
                } else {
                    // Non-admin mode: default to thisHost only
                    destinations = {
                        arweave: false,
                        gun: false,
                        thisHost: true
                    };
                }

                // Send to server (server pays Arweave fee, no signature)
                const response = await fetch('/onion-press/api/records/publishAnonymous', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        payload,
                        destinations
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || result.error || 'Publishing failed');
                }

                // Build success message based on destinations
                let successMessage = '<p>Your anonymous record has been published!</p>';
                
                if (result.destinations?.arweave?.success) {
                    successMessage += `
                        <p><strong>âœ… Arweave:</strong> Published</p>
                        <p><strong>Transaction ID:</strong> <span class="tx-link">${result.transactionId}</span></p>
                        <p><a href="${result.explorerUrl}" target="_blank">View on Arweave Explorer â†’</a></p>
                    `;
                } else if (result.destinations?.arweave) {
                    successMessage += `<p><strong>âŒ Arweave:</strong> ${result.destinations.arweave.error || 'Failed'}</p>`;
                }
                
                if (result.destinations?.thisHost?.success) {
                    successMessage += `
                        <p><strong>âœ… WordPress:</strong> Published</p>
                        <p><strong>Post ID:</strong> ${result.destinations.thisHost.postId}</p>
                        <p><a href="${result.destinations.thisHost.permalink}" target="_blank">View WordPress Post â†’</a></p>
                    `;
                } else if (result.destinations?.thisHost) {
                    successMessage += `<p><strong>âŒ WordPress:</strong> ${result.destinations.thisHost.error || 'Failed'}</p>`;
                }
                
                showStatus('success', 'âœ… Published Successfully!', successMessage);

                // Clear form
                document.getElementById('anonTitle').value = '';
                document.getElementById('anonDescription').value = '';
                document.getElementById('anonContent').value = '';
                document.getElementById('anonWebUrl').value = '';
                document.getElementById('anonTags').value = '';

            } catch (error) {
                console.error('Publish error:', error);
                showStatus('error', 'âŒ Publishing Failed', error.message);
            } finally {
                publishBtn.disabled = false;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI HELPERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function showStatus(type, title, message) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status-message visible ${type}`;
            statusEl.innerHTML = `<h3>${title}</h3><div>${message}</div>`;
        }

        function updatePublishButton() {
            const publishBtn = document.getElementById('publishBtn');
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();

            publishBtn.disabled = !identity || !title || !content;
        }

        function updateAnonymousPublishButton() {
            const publishBtn = document.getElementById('anonPublishBtn');
            const title = document.getElementById('anonTitle').value.trim();
            const content = document.getElementById('anonContent').value.trim();

            publishBtn.disabled = !title || !content;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EVENT HANDLERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        document.addEventListener('DOMContentLoaded', async () => {
            // Check admin status and update UI
            await checkAdminStatus();
            // Load host info for both forms
            try {
                const response = await fetch('/onion-press/api/host-info');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('thisHostName').textContent = data.name;
                    document.getElementById('thisHostUrl').textContent = data.url;
                    document.getElementById('anonThisHostName').textContent = data.name;
                    document.getElementById('anonThisHostUrl').textContent = data.url;
                }
            } catch (error) {
                console.warn('Failed to load host info:', error);
            }

            // Check TOR status
            try {
                const torResponse = await fetch('/onion-press/api/tor/status');
                if (torResponse.ok) {
                    const torStatus = await torResponse.json();
                    const torIndicator = document.querySelector('#torStatus .tor-indicator');
                    if (torStatus.connected) {
                        torIndicator.classList.add('connected');
                        torIndicator.classList.remove('disconnected');
                    } else {
                        torIndicator.classList.remove('connected');
                        torIndicator.classList.add('disconnected');
                    }
                }
            } catch (error) {
                console.warn('Failed to check TOR status:', error);
            }

            // DID Form handlers
            const mnemonicEl = document.getElementById('mnemonic');
            const generateBtn = document.getElementById('generateMnemonicBtn');
            const loadBtn = document.getElementById('loadIdentityBtn');
            const publishBtn = document.getElementById('publishBtn');
            const identitySection = document.getElementById('identitySection');
            const identityInfo = document.getElementById('identityInfo');
            const displayDid = document.getElementById('displayDid');
            const displayXpub = document.getElementById('displayXpub');

            // Generate test mnemonic
            generateBtn.addEventListener('click', () => {
                const mnemonic = generateMnemonic(wordlist, 256); // 24 words
                mnemonicEl.value = mnemonic;
            });

            // Load identity from mnemonic
            loadBtn.addEventListener('click', () => {
                try {
                    const mnemonic = mnemonicEl.value.trim().toLowerCase();
                    if (!mnemonic) {
                        alert('Please enter a mnemonic phrase');
                        return;
                    }

                    identity = createIdentity(mnemonic);
                    
                    // Update UI
                    identitySection.classList.add('active');
                    identityInfo.classList.remove('hidden');
                    displayDid.textContent = identity.did;
                    displayXpub.textContent = identity.signingXpub;
                    
                    updatePublishButton();
                    
                    console.log('Identity loaded:', identity.did);
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            });

            // Publish record (DID mode)
            publishBtn.addEventListener('click', publishRecord);

            // Update publish button state on form changes (DID)
            document.getElementById('title').addEventListener('input', updatePublishButton);
            document.getElementById('content').addEventListener('input', updatePublishButton);

            // Anonymous Form handlers
            const anonPublishBtn = document.getElementById('anonPublishBtn');
            anonPublishBtn.addEventListener('click', publishAnonymous);

            // Update publish button state on form changes (Anonymous)
            document.getElementById('anonTitle').addEventListener('input', updateAnonymousPublishButton);
            document.getElementById('anonContent').addEventListener('input', updateAnonymousPublishButton);

            // Destination card selection styling
            document.querySelectorAll('.destination-card').forEach(card => {
                const checkbox = card.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', () => {
                    card.classList.toggle('selected', checkbox.checked);
                });
            });
        });

        /**
         * Check admin status and update UI
         */
        async function checkAdminStatus() {
            try {
                // Check if user is logged in
                const token = localStorage.getItem('onionpress_token');
                if (!token) {
                    // Not logged in, hide admin-only sections
                    document.querySelectorAll('.admin-only').forEach(el => {
                        el.classList.add('hidden');
                    });
                    return;
                }

                // Check WordPress admin status
                const response = await fetch('/onion-press/api/user/admin-status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const isAdmin = data.isWordPressAdmin || false;

                    // Show/hide admin-only sections
                    document.querySelectorAll('.admin-only').forEach(el => {
                        if (isAdmin) {
                            el.classList.remove('hidden');
                        } else {
                            el.classList.add('hidden');
                        }
                    });
                }
            } catch (error) {
                console.warn('Failed to check admin status:', error);
                // Hide admin sections on error
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.classList.add('hidden');
                });
            }
        }

        // Make functions available globally
        window.selectMethod = selectMethod;
        window.showMethodSelection = showMethodSelection;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê OIP v0.9 Creator Registration</title>
    <link rel="stylesheet" href="css/onion-press.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-step-1: #f472b6;  /* Pink - Identity */
            --accent-step-2: #fb923c;  /* Orange - Verification Method */
            --accent-step-3: #60a5fa;  /* Blue - DID Document */
            --accent-step-4: #34d399;  /* Green - Social Media */
            --accent-step-5: #a78bfa;  /* Purple - Communication */
            --accent-step-6: #22d3ee;  /* Cyan - Review & Publish */
            --font-mono: 'IBM Plex Mono', 'JetBrains Mono', monospace;
        }

        .registration-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }

        .registration-header {
            text-align: center;
            margin-bottom: var(--spacing-2xl);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .registration-header h1 {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
            background: linear-gradient(135deg, var(--accent-step-1), var(--accent-step-6));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .step-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-2xl);
            position: relative;
        }

        .step-progress::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border-color);
        }

        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-family: var(--font-mono);
            transition: var(--transition-normal);
        }

        .step-indicator.active .step-number {
            transform: scale(1.1);
        }

        .step-indicator[data-step="1"].active .step-number,
        .step-indicator[data-step="1"].completed .step-number { background: var(--accent-step-1); border-color: var(--accent-step-1); }
        .step-indicator[data-step="2"].active .step-number,
        .step-indicator[data-step="2"].completed .step-number { background: var(--accent-step-2); border-color: var(--accent-step-2); }
        .step-indicator[data-step="3"].active .step-number,
        .step-indicator[data-step="3"].completed .step-number { background: var(--accent-step-3); border-color: var(--accent-step-3); }
        .step-indicator[data-step="4"].active .step-number,
        .step-indicator[data-step="4"].completed .step-number { background: var(--accent-step-4); border-color: var(--accent-step-4); }
        .step-indicator[data-step="5"].active .step-number,
        .step-indicator[data-step="5"].completed .step-number { background: var(--accent-step-5); border-color: var(--accent-step-5); }
        .step-indicator[data-step="6"].active .step-number,
        .step-indicator[data-step="6"].completed .step-number { background: var(--accent-step-6); border-color: var(--accent-step-6); }

        .step-label {
            margin-top: var(--spacing-sm);
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
            max-width: 80px;
        }

        .step-indicator.active .step-label {
            color: var(--text-primary);
            font-weight: 600;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .step-section {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
        }

        .step-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-family: var(--font-mono);
            margin-right: var(--spacing-sm);
        }

        .step-badge.step-1 { background: var(--accent-step-1); color: #000; }
        .step-badge.step-2 { background: var(--accent-step-2); color: #000; }
        .step-badge.step-3 { background: var(--accent-step-3); color: #000; }
        .step-badge.step-4 { background: var(--accent-step-4); color: #000; }
        .step-badge.step-5 { background: var(--accent-step-5); color: #000; }
        .step-badge.step-6 { background: var(--accent-step-6); color: #000; }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group small {
            display: block;
            margin-top: var(--spacing-xs);
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .repeated-field {
            margin-bottom: var(--spacing-md);
        }

        .repeated-field-item {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .repeated-field-item input {
            flex: 1;
        }

        .add-field-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.85rem;
        }

        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }

        .nav-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .nav-btn.prev {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-btn.next,
        .nav-btn.approve {
            background: var(--accent-primary);
            color: #000;
        }

        .nav-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .identity-card {
            background: var(--bg-tertiary);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .identity-row {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .identity-row:last-child {
            border-bottom: none;
        }

        .identity-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .identity-value {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            word-break: break-all;
            color: var(--text-primary);
        }

        .alert {
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-lg);
        }

        .alert.info {
            background: rgba(34, 211, 238, 0.1);
            border: 1px solid var(--accent-step-6);
            color: var(--text-primary);
        }

        .alert.warning {
            background: rgba(251, 146, 60, 0.1);
            border: 1px solid var(--accent-step-2);
            color: var(--text-primary);
        }

        .json-display {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            font-family: var(--font-mono);
            font-size: 0.85rem;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }

        .template-field-info {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: var(--spacing-xs);
        }
    </style>
</head>
<body>
    <main class="registration-container">
        <div class="registration-header">
            <h1>üîê OIP v0.9 Creator Registration</h1>
            <p>Register yourself as a creator using DID-based identity</p>
        </div>

        <div class="step-progress">
            <div class="step-indicator active" data-step="1" onclick="goToStep(1)">
                <div class="step-number">1</div>
                <div class="step-label">Identity</div>
            </div>
            <div class="step-indicator" data-step="2" onclick="goToStep(2)">
                <div class="step-number">2</div>
                <div class="step-label">Verification Method</div>
            </div>
            <div class="step-indicator" data-step="3" onclick="goToStep(3)">
                <div class="step-number">3</div>
                <div class="step-label">DID Document</div>
            </div>
            <div class="step-indicator" data-step="4" onclick="goToStep(4)">
                <div class="step-number">4</div>
                <div class="step-label">Social Media</div>
            </div>
            <div class="step-indicator" data-step="5" onclick="goToStep(5)">
                <div class="step-number">5</div>
                <div class="step-label">Communication</div>
            </div>
            <div class="step-indicator" data-step="6" onclick="goToStep(6)">
                <div class="step-number">6</div>
                <div class="step-label">Review & Publish</div>
            </div>
        </div>

        <!-- Step 1: Identity -->
        <div id="step1" class="step-content active">
            <div class="step-section">
                <h2><span class="step-badge step-1">1</span> Creator Identity</h2>
                
                <div class="alert warning">
                    <strong>‚ö†Ô∏è Security Warning</strong><br>
                    Your mnemonic is your identity and signing key. It is processed entirely in your browser and never sent to any server. 
                    Keep it secure and never share it!
                </div>

                <div class="form-group">
                    <label for="mnemonic">BIP-39 Mnemonic (12 or 24 words)</label>
                    <textarea id="mnemonic" rows="3" placeholder="Enter your mnemonic phrase here, or click 'Generate Test Mnemonic' below..."></textarea>
                    <small>This mnemonic will be used to derive your DID and signing keys</small>
                </div>

                <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg);">
                    <button id="generateMnemonicBtn" class="nav-btn prev">üé≤ Generate Test Mnemonic</button>
                    <button id="loadIdentityBtn" class="nav-btn next">üîë Load Identity</button>
                </div>

                <div id="identityInfo" class="identity-card hidden">
                    <h3>Your Identity</h3>
                    <div class="identity-row">
                        <span class="identity-label">DID</span>
                        <span class="identity-value" id="displayDid">-</span>
                    </div>
                    <div class="identity-row">
                        <span class="identity-label">Signing xpub</span>
                        <span class="identity-value" id="displayXpub">-</span>
                    </div>
                </div>
            </div>

            <div class="step-navigation">
                <div></div>
                <button class="nav-btn next" onclick="processStep1()" id="step1NextBtn" disabled>
                    Continue to Verification Method ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 2: Verification Method -->
        <div id="step2" class="step-content">
            <div class="step-section">
                <h2><span class="step-badge step-2">2</span> Verification Method</h2>
                
                <div class="alert info">
                    A verification method defines how others can verify signatures from your DID. This will be published as a separate record.
                </div>

                <div id="verificationMethodForm">
                    <div class="loading">Loading template fields...</div>
                </div>
            </div>

            <div class="step-navigation">
                <button class="nav-btn prev" onclick="goToStep(1)">‚Üê Back to Identity</button>
                <button class="nav-btn next" onclick="processStep2()">Continue to DID Document ‚Üí</button>
            </div>
        </div>

        <!-- Step 3: DID Document -->
        <div id="step3" class="step-content">
            <div class="step-section">
                <h2><span class="step-badge step-3">3</span> DID Document</h2>
                
                <div class="alert info">
                    Your DID Document is your public identity profile. It references your verification method and includes profile information.
                </div>

                <div id="didDocumentForm">
                    <div class="loading">Loading template fields...</div>
                </div>
            </div>

            <div class="step-navigation">
                <button class="nav-btn prev" onclick="goToStep(2)">‚Üê Back to Verification Method</button>
                <button class="nav-btn next" onclick="processStep3()">Continue to Social Media ‚Üí</button>
            </div>
        </div>

        <!-- Step 4: Social Media -->
        <div id="step4" class="step-content">
            <div class="step-section">
                <h2><span class="step-badge step-4">4</span> Social Media</h2>
                
                <div class="alert info">
                    Optionally link your social media profiles. This information will be publicly available.
                </div>

                <div id="socialMediaForm">
                    <div class="loading">Loading template fields...</div>
                </div>
            </div>

            <div class="step-navigation">
                <button class="nav-btn prev" onclick="goToStep(3)">‚Üê Back to DID Document</button>
                <button class="nav-btn next" onclick="processStep4()">Continue to Communication ‚Üí</button>
            </div>
        </div>

        <!-- Step 5: Communication -->
        <div id="step5" class="step-content">
            <div class="step-section">
                <h2><span class="step-badge step-5">5</span> Communication</h2>
                
                <div class="alert info">
                    Optionally add communication channels. This information will be publicly available.
                </div>

                <div id="communicationForm">
                    <div class="loading">Loading template fields...</div>
                </div>
            </div>

            <div class="step-navigation">
                <button class="nav-btn prev" onclick="goToStep(4)">‚Üê Back to Social Media</button>
                <button class="nav-btn next" onclick="processStep5()">Review & Publish ‚Üí</button>
            </div>
        </div>

        <!-- Step 6: Review & Publish -->
        <div id="step6" class="step-content">
            <div class="step-section">
                <h2><span class="step-badge step-6">6</span> Review & Publish</h2>
                
                <div class="alert info">
                    Review all your records before publishing. Each record will be signed with your identity and published to Arweave.
                </div>

                <h3>Records to Publish</h3>
                <div id="reviewRecords" class="json-display">
                    <!-- Populated by JS -->
                </div>

                <div style="margin-top: var(--spacing-lg);">
                    <label>
                        <input type="checkbox" id="confirmPublish">
                        I confirm that all information is correct and I want to publish these records to the blockchain
                    </label>
                </div>
            </div>

            <div class="step-navigation">
                <button class="nav-btn prev" onclick="goToStep(5)">‚Üê Back to Communication</button>
                <button class="nav-btn approve" id="publishBtn" onclick="publishRecords()" disabled>
                    ‚úÖ Publish All Records
                </button>
            </div>

            <div id="publishResult" class="hidden" style="margin-top: var(--spacing-lg);"></div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.origin;
        
        let state = {
            identity: null,
            templates: {},
            records: {
                didVerificationMethod: null,
                didDocument: null,
                socialMedia: null,
                communication: null
            }
        };

        // Load templates on page load
        async function loadTemplates() {
            try {
                // Try to load all templates first
                const response = await fetch(`${API_BASE}/api/templates`);
                const data = await response.json();
                
                if (data.templates) {
                    const v09Templates = ['didVerificationMethod', 'didDocument', 'socialMedia', 'communication'];
                    
                    data.templates.forEach(template => {
                        const templateName = template.data?.template || template.data?.recordType;
                        if (v09Templates.includes(templateName)) {
                            state.templates[templateName] = template;
                        }
                    });

                    // Check if we found all required templates
                    const missingTemplates = v09Templates.filter(name => !state.templates[name]);
                    if (missingTemplates.length > 0) {
                        console.warn('Missing templates:', missingTemplates);
                        // Try to query by template name
                        for (const templateName of missingTemplates) {
                            try {
                                const templateResponse = await fetch(`${API_BASE}/api/templates/${templateName}`);
                                if (templateResponse.ok) {
                                    const templateData = await templateResponse.json();
                                    if (templateData.template) {
                                        state.templates[templateName] = templateData.template;
                                    }
                                }
                            } catch (err) {
                                console.warn(`Could not load template ${templateName}:`, err);
                            }
                        }
                    }

                    // Render forms for each template
                    renderTemplateForm('didVerificationMethod', 'verificationMethodForm');
                    renderTemplateForm('didDocument', 'didDocumentForm');
                    renderTemplateForm('socialMedia', 'socialMediaForm');
                    renderTemplateForm('communication', 'communicationForm');
                } else {
                    throw new Error('No templates found in response');
                }
            } catch (error) {
                console.error('Failed to load templates:', error);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'alert warning';
                errorMsg.innerHTML = `<strong>‚ö†Ô∏è Template Loading Error</strong><br>Failed to load templates: ${error.message}<br><small>Please ensure the v0.9 templates are published and indexed.</small>`;
                document.getElementById('verificationMethodForm').innerHTML = '';
                document.getElementById('verificationMethodForm').appendChild(errorMsg);
            }
        }

        function renderTemplateForm(templateName, containerId) {
            const template = state.templates[templateName];
            if (!template) {
                document.getElementById(containerId).innerHTML = '<div class="alert warning">Template not found. Please ensure templates are published.</div>';
                return;
            }

            const fieldsInTemplate = template.data?.fieldsInTemplate || {};
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            Object.entries(fieldsInTemplate).forEach(([fieldName, fieldInfo]) => {
                const fieldType = fieldInfo.type || 'string';
                const fieldIndex = fieldInfo.index;
                
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                const label = document.createElement('label');
                label.textContent = fieldName;
                label.setAttribute('for', `${templateName}_${fieldName}`);
                
                const info = document.createElement('small');
                info.className = 'template-field-info';
                info.textContent = `Type: ${fieldType}, Index: ${fieldIndex}`;
                
                formGroup.appendChild(label);
                formGroup.appendChild(info);

                if (fieldType.startsWith('repeated ')) {
                    const repeatedContainer = document.createElement('div');
                    repeatedContainer.className = 'repeated-field';
                    repeatedContainer.id = `${templateName}_${fieldName}_container`;
                    
                    const addBtn = document.createElement('button');
                    addBtn.type = 'button';
                    addBtn.className = 'add-field-btn';
                    addBtn.textContent = '+ Add';
                    addBtn.onclick = () => addRepeatedField(templateName, fieldName, fieldType);
                    
                    repeatedContainer.appendChild(addBtn);
                    formGroup.appendChild(repeatedContainer);
                    
                    // Add initial field (only if not a required auto-filled field)
                    if (!(templateName === 'didDocument' && (fieldName === 'verificationMethod' || fieldName === 'authentication' || fieldName === 'assertionMethod'))) {
                        addRepeatedField(templateName, fieldName, fieldType);
                    }
                } else if (fieldType === 'enum') {
                    const select = document.createElement('select');
                    select.id = `${templateName}_${fieldName}`;
                    select.name = fieldName;
                    
                    const enumValues = fieldInfo.enumValues || [];
                    enumValues.forEach((value, index) => {
                        const option = document.createElement('option');
                        option.value = typeof value === 'object' ? value.code : value;
                        option.textContent = typeof value === 'object' ? value.name : value;
                        select.appendChild(option);
                    });
                    
                    formGroup.appendChild(select);
                } else if (fieldType === 'bool') {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `${templateName}_${fieldName}`;
                    checkbox.name = fieldName;
                    formGroup.appendChild(checkbox);
                } else {
                    const input = document.createElement('input');
                    input.type = fieldType === 'uint64' || fieldType === 'uint32' ? 'number' : 'text';
                    input.id = `${templateName}_${fieldName}`;
                    input.name = fieldName;
                    if (fieldType === 'dref') {
                        input.placeholder = 'did:arweave:...';
                    }
                    formGroup.appendChild(input);
                }

                container.appendChild(formGroup);
            });
        }

        function addRepeatedField(templateName, fieldName, fieldType) {
            const container = document.getElementById(`${templateName}_${fieldName}_container`);
            const item = document.createElement('div');
            item.className = 'repeated-field-item';
            
            const input = document.createElement('input');
            input.type = fieldType.includes('dref') ? 'text' : 'text';
            input.placeholder = fieldType.includes('dref') ? 'did:arweave:...' : 'Enter value...';
            input.name = `${templateName}_${fieldName}[]`;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = '√ó';
            removeBtn.className = 'add-field-btn';
            removeBtn.onclick = () => item.remove();
            
            item.appendChild(input);
            item.appendChild(removeBtn);
            container.insertBefore(item, container.firstChild);
        }

        function goToStep(step) {
            if (step > 1 && !state.identity) {
                alert('Please create your identity first');
                return;
            }

            document.querySelectorAll('.step-indicator').forEach((el, i) => {
                el.classList.remove('active');
                if (i + 1 < step) el.classList.add('completed');
                else if (i + 1 === step) el.classList.add('active');
                else el.classList.remove('completed');
            });

            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
        }

        // Step 1: Load Identity
        document.getElementById('generateMnemonicBtn').onclick = async () => {
            try {
                const response = await fetch(`${API_BASE}/api/debug/generate-mnemonic`);
                const data = await response.json();
                document.getElementById('mnemonic').value = data.mnemonic;
            } catch (error) {
                alert('Failed to generate mnemonic');
            }
        };

        document.getElementById('loadIdentityBtn').onclick = async () => {
            const mnemonic = document.getElementById('mnemonic').value.trim();
            if (!mnemonic) {
                alert('Please enter a mnemonic');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/debug/identity`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mnemonic })
                });

                if (!response.ok) throw new Error('Failed to create identity');

                state.identity = await response.json();
                document.getElementById('identityInfo').classList.remove('hidden');
                document.getElementById('displayDid').textContent = state.identity.did;
                document.getElementById('displayXpub').textContent = state.identity.signingXpub.substring(0, 50) + '...';
                document.getElementById('step1NextBtn').disabled = false;
            } catch (error) {
                alert('Failed to load identity: ' + error.message);
            }
        };

        async function processStep1() {
            if (!state.identity) {
                alert('Please load your identity first');
                return;
            }
            goToStep(2);
        }

        async function processStep2() {
            if (!state.identity) {
                alert('Please create your identity first');
                return;
            }

            const record = collectFormData('didVerificationMethod');
            
            // Auto-fill verification method fields from identity
            if (!record.vmId) {
                const vmIdInput = document.getElementById('didVerificationMethod_vmId');
                if (vmIdInput) vmIdInput.value = '#sign';
            }
            if (!record.vmType) {
                const vmTypeInput = document.getElementById('didVerificationMethod_vmType');
                if (vmTypeInput) vmTypeInput.value = 'oip:XpubDerivation2025';
            }
            if (!record.controller) {
                const controllerInput = document.getElementById('didVerificationMethod_controller');
                if (controllerInput) controllerInput.value = state.identity.did;
            }
            if (!record.xpub) {
                const xpubInput = document.getElementById('didVerificationMethod_xpub');
                if (xpubInput) xpubInput.value = state.identity.signingXpub;
            }
            if (!record.derivationSubPurpose) {
                const subPurposeInput = document.getElementById('didVerificationMethod_derivationSubPurpose');
                if (subPurposeInput) subPurposeInput.value = 'identity.sign';
            }
            if (!record.derivationAccount) {
                const accountInput = document.getElementById('didVerificationMethod_derivationAccount');
                if (accountInput) accountInput.value = '0';
            }
            if (!record.derivationPathPrefix) {
                const pathInput = document.getElementById('didVerificationMethod_derivationPathPrefix');
                if (pathInput) pathInput.value = `m/176800'/0'/0'`;
            }
            if (!record.leafIndexPolicy) {
                const policyInput = document.getElementById('didVerificationMethod_leafIndexPolicy');
                if (policyInput && policyInput.options.length > 0) {
                    // Find and select 'payload_digest' option
                    for (let option of policyInput.options) {
                        if (option.value === 'payload_digest' || option.text.includes('payload')) {
                            policyInput.value = option.value;
                            break;
                        }
                    }
                }
            }
            if (record.leafHardened === undefined) {
                const hardenedInput = document.getElementById('didVerificationMethod_leafHardened');
                if (hardenedInput) hardenedInput.checked = false;
            }
            if (!record.validFromBlock) {
                const validFromInput = document.getElementById('didVerificationMethod_validFromBlock');
                if (validFromInput) validFromInput.value = '0';
            }
            
            // Re-collect form data after auto-fill
            const updatedRecord = collectFormData('didVerificationMethod');
            state.records.didVerificationMethod = updatedRecord;
            goToStep(3);
        }

        async function processStep3() {
            if (!state.identity) {
                alert('Please create your identity first');
                return;
            }

            const record = collectFormData('didDocument');
            
            // Auto-fill DID document fields
            const didInput = document.getElementById('didDocument_did');
            if (didInput && !didInput.value) didInput.value = state.identity.did;
            
            const controllerInput = document.getElementById('didDocument_controller');
            if (controllerInput && !controllerInput.value) controllerInput.value = state.identity.did;
            
            // Note: verificationMethod will be set after VM is published
            // For repeated fields like authentication and assertionMethod, add initial values
            const authContainer = document.getElementById('didDocument_authentication_container');
            if (authContainer && authContainer.querySelectorAll('input').length === 0) {
                addRepeatedField('didDocument', 'authentication', 'repeated string');
                const authInput = authContainer.querySelector('input');
                if (authInput) authInput.value = '#sign';
            }
            
            const assertionContainer = document.getElementById('didDocument_assertionMethod_container');
            if (assertionContainer && assertionContainer.querySelectorAll('input').length === 0) {
                addRepeatedField('didDocument', 'assertionMethod', 'repeated string');
                const assertionInput = assertionContainer.querySelector('input');
                if (assertionInput) assertionInput.value = '#sign';
            }
            
            // Note: verificationMethod will be populated after VM is published
            
            const keyPolicyInput = document.getElementById('didDocument_keyBindingPolicy');
            if (keyPolicyInput && !keyPolicyInput.value) {
                keyPolicyInput.value = 'xpub';
            }
            
            // Re-collect form data after auto-fill
            const updatedRecord = collectFormData('didDocument');
            updatedRecord.did = updatedRecord.did || state.identity.did;
            updatedRecord.controller = updatedRecord.controller || state.identity.did;
            updatedRecord.keyBindingPolicy = updatedRecord.keyBindingPolicy || 'xpub';
            
            state.records.didDocument = updatedRecord;
            goToStep(4);
        }

        async function processStep4() {
            const record = collectFormData('socialMedia');
            state.records.socialMedia = record;
            goToStep(5);
        }

        async function processStep5() {
            const record = collectFormData('communication');
            state.records.communication = record;
            
            // Show review
            document.getElementById('reviewRecords').textContent = JSON.stringify(state.records, null, 2);
            goToStep(6);
        }

        function collectFormData(templateName) {
            const template = state.templates[templateName];
            if (!template) return null;

            const fieldsInTemplate = template.data?.fieldsInTemplate || {};
            const record = {};

            Object.keys(fieldsInTemplate).forEach(fieldName => {
                const fieldInfo = fieldsInTemplate[fieldName];
                const fieldType = fieldInfo.type || 'string';
                const elementId = `${templateName}_${fieldName}`;

                if (fieldType.startsWith('repeated ')) {
                    const inputs = document.querySelectorAll(`input[name="${templateName}_${fieldName}[]"]`);
                    const values = Array.from(inputs).map(input => input.value.trim()).filter(v => v);
                    if (values.length > 0) record[fieldName] = values;
                } else if (fieldType === 'bool') {
                    const checkbox = document.getElementById(elementId);
                    record[fieldName] = checkbox ? checkbox.checked : false;
                } else {
                    const input = document.getElementById(elementId);
                    if (input && input.value.trim()) {
                        record[fieldName] = input.value.trim();
                    }
                }
            });

            return record;
        }

        document.getElementById('confirmPublish').onchange = function() {
            document.getElementById('publishBtn').disabled = !this.checked;
        };

        async function publishRecords() {
            if (!document.getElementById('confirmPublish').checked) {
                alert('Please confirm before publishing');
                return;
            }

            const resultDiv = document.getElementById('publishResult');
            const publishBtn = document.getElementById('publishBtn');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<div class="loading">Publishing records...</div>';
            publishBtn.disabled = true;
            publishBtn.textContent = '‚è≥ Publishing...';

            const results = {};
            const errors = [];
            let vmDid = null; // Store verification method DID for reference in DID document

            try {
                const mnemonic = document.getElementById('mnemonic').value.trim();
                
                // Publish records in order: verificationMethod -> didDocument -> socialMedia -> communication
                const publishOrder = [
                    { name: 'didVerificationMethod', template: 'didVerificationMethod', required: true },
                    { name: 'didDocument', template: 'didDocument', required: true },
                    { name: 'socialMedia', template: 'socialMedia', required: false },
                    { name: 'communication', template: 'communication', required: false }
                ];

                for (const { name, template, required } of publishOrder) {
                    let record = state.records[name];
                    if (!record && required) {
                        errors.push(`${name}: Required record is missing`);
                        results[name] = { success: false, error: 'Required record is missing' };
                        continue;
                    }
                    if (!record) continue;

                    try {
                        // If this is the DID document and we have a VM DID, update the reference
                        if (name === 'didDocument' && vmDid) {
                            // Create a copy to avoid mutating the original
                            record = { ...record };
                            if (!record.verificationMethod || !Array.isArray(record.verificationMethod)) {
                                record.verificationMethod = [];
                            }
                            // Add or update the VM reference
                            if (record.verificationMethod.length === 0 || record.verificationMethod[0] !== vmDid) {
                                record.verificationMethod = [vmDid];
                            }
                        }

                        // Build OIP v0.9 payload
                        const templateDid = state.templates[template]?.oip?.didTx || state.templates[template]?.oip?.did;
                        if (!templateDid) {
                            throw new Error(`Template DID not found for ${template}`);
                        }

                        // Convert record to compressed format using template
                        const compressedRecord = convertToCompressedFormat(record, template);
                        
                        // Build fragments structure
                        const payload = {
                            '@context': state.identity.did,
                            tags: [
                                { name: 'Content-Type', value: 'application/json' },
                                { name: 'Index-Method', value: 'OIP' },
                                { name: 'Ver', value: '0.9.0' },
                                { name: 'Type', value: 'Record' },
                                { name: 'RecordType', value: template },
                                { name: 'Creator', value: state.identity.did }
                            ],
                            fragments: [{
                                id: `fragment-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                                dataType: 'Record',
                                recordType: template,
                                records: [compressedRecord]
                            }]
                        };

                        // Sign the payload using debug endpoint
                        const signResponse = await fetch(`${API_BASE}/api/debug/sign`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                payload: payload,
                                mnemonic: mnemonic
                            })
                        });

                        if (!signResponse.ok) {
                            const error = await signResponse.json();
                            throw new Error(error.error || 'Signing failed');
                        }

                        const signedPayload = await signResponse.json();
                        
                        // Publish to Arweave using /api/records/newRecord
                        const publishResponse = await fetch(`${API_BASE}/api/records/newRecord?recordType=${template}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                record: signedPayload
                            })
                        });

                        if (!publishResponse.ok) {
                            const error = await publishResponse.json();
                            throw new Error(error.error || 'Publishing failed');
                        }

                        const result = await publishResponse.json();
                        const txId = result.transactionId || result.did || result.didTx;
                        const did = result.did || `did:arweave:${txId}`;
                        
                        results[name] = {
                            success: true,
                            txId: txId,
                            did: did
                        };

                        // Store verification method DID for reference in DID document
                        if (name === 'didVerificationMethod') {
                            vmDid = did;
                            // Update the DID document record to reference this VM
                            // The verificationMethod field should contain the VM DID
                            if (state.records.didDocument && !state.records.didDocument.verificationMethod) {
                                state.records.didDocument.verificationMethod = [vmDid];
                            } else if (state.records.didDocument && Array.isArray(state.records.didDocument.verificationMethod)) {
                                // Replace or add the VM reference
                                if (state.records.didDocument.verificationMethod.length === 0) {
                                    state.records.didDocument.verificationMethod = [vmDid];
                                } else {
                                    state.records.didDocument.verificationMethod[0] = vmDid;
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`Error publishing ${name}:`, error);
                        errors.push(`${name}: ${error.message}`);
                        results[name] = {
                            success: false,
                            error: error.message
                        };
                    }
                }

                // Display results
                let html = '<div class="alert info"><h3>üìã Publishing Results</h3>';
                
                Object.entries(results).forEach(([name, result]) => {
                    if (result.success) {
                        html += `<p>‚úÖ <strong>${name}</strong>: Published<br>`;
                        html += `<code style="font-size: 0.85rem; word-break: break-all;">${result.did || result.txId}</code></p>`;
                    } else {
                        html += `<p>‚ùå <strong>${name}</strong>: Failed<br>`;
                        html += `<small style="color: var(--text-warning);">${result.error}</small></p>`;
                    }
                });

                if (errors.length > 0) {
                    html += `<div style="margin-top: var(--spacing-md);">`;
                    html += `<strong style="color: var(--text-warning);">Errors:</strong><ul style="color: var(--text-warning);">`;
                    errors.forEach(err => html += `<li>${err}</li>`);
                    html += `</ul></div>`;
                }

                html += '</div>';
                resultDiv.innerHTML = html;

                if (errors.length === 0) {
                    publishBtn.textContent = '‚úÖ All Records Published!';
                    publishBtn.style.background = 'var(--accent-step-4)';
                } else {
                    publishBtn.disabled = false;
                    publishBtn.textContent = '‚ö†Ô∏è Retry Publishing';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert warning"><h3>‚ùå Error</h3><p>${error.message}</p></div>`;
                publishBtn.disabled = false;
                publishBtn.textContent = '‚úÖ Publish All Records';
            }
        }

        function convertToCompressedFormat(record, templateName) {
            const template = state.templates[templateName];
            if (!template) throw new Error(`Template ${templateName} not found`);

            const fieldsInTemplate = template.data?.fieldsInTemplate || {};
            const templateDid = template.oip?.didTx || template.oip?.did;
            
            if (!templateDid) {
                throw new Error(`Template DID not found for ${templateName}`);
            }
            
            const compressed = { t: templateDid };

            Object.entries(fieldsInTemplate).forEach(([fieldName, fieldInfo]) => {
                const value = record[fieldName];
                if (value === undefined || value === null || value === '') return;

                const index = fieldInfo.index;
                const fieldType = fieldInfo.type || 'string';

                if (fieldType.startsWith('repeated ')) {
                    if (Array.isArray(value) && value.length > 0) {
                        compressed[index] = value;
                    }
                } else if (fieldType === 'enum') {
                    const enumValues = fieldInfo.enumValues || [];
                    const enumIndex = enumValues.findIndex(v => 
                        (typeof v === 'object' ? v.code : v) === value
                    );
                    compressed[index] = enumIndex !== -1 ? enumIndex : value;
                } else if (fieldType === 'bool') {
                    compressed[index] = value === true || value === 'true';
                } else {
                    compressed[index] = value;
                }
            });

            return compressed;
        }

        // Initialize
        loadTemplates();
    </script>
</body>
</html>

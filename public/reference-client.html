<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OIP Explorer - Browse & Publish Records</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
        }

        .nav-tabs {
            display: flex;
            gap: 20px;
        }

        .nav-tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            border-color: white;
        }

        .auth-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .filters-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }

        .filter-group.wide {
            flex: 2;
            min-width: 200px;
        }

        .search-container {
            flex: 3;
            min-width: 300px;
        }

        .records-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            min-height: 600px;
        }

        .records-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .record-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }

        .record-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .record-type {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .record-block {
            color: #666;
            font-size: 0.9rem;
        }

        .record-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .record-content {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .record-meta {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.8rem;
            color: #999;
        }

        .tags-container {
            margin-top: 10px;
        }

        .tag {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin: 2px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .tag:hover {
            background: #667eea;
            color: white;
        }

        /* Media content styling */
        .media-content {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .media-item {
            margin: 10px 0;
        }

        .media-item img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .media-item img:hover {
            transform: scale(1.02);
        }

        .media-item audio,
        .media-item video {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .media-item button {
            transition: all 0.2s;
        }

        .media-item button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .text-content {
            border: 1px solid #dee2e6;
            background: white;
            font-family: 'Courier New', monospace;
            line-height: 1.4;
        }

        .media-item label {
            color: #495057;
            font-size: 14px;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 28px;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .hidden {
            display: none;
        }

        .logged-in-user {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 14px;
        }

        .dynamic-fields {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            background: white;
        }

        .field-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .field-row > div {
            flex: 1;
        }

        .field-row button {
            margin: 0;
            padding: 8px 12px;
            font-size: 14px;
        }

        .date-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-inputs input {
            flex: 1;
        }

        .advanced-filters {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .toggle-row {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 10px;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .load-more {
            text-align: center;
            margin: 20px 0;
        }

        .no-results {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px;
        }

        .pagination-info {
            text-align: center;
            color: #666;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-tabs {
                order: -1;
            }
            
            .filters-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group,
            .filter-group.wide,
            .search-container {
                min-width: auto;
                flex: none;
            }
            
            .records-grid {
                grid-template-columns: 1fr;
            }
            
            .field-row {
                flex-direction: column;
                gap: 5px;
            }
            
            .date-inputs {
                flex-direction: column;
            }
            
            .toggle-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">OIP Explorer</div>
            
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showBrowseTab()">Browse Records</div>
                <div class="nav-tab" onclick="showPublishTab()">Publish</div>
            </div>
            
            <div class="auth-section">
                <div id="user-info" class="hidden">
                    <span id="logged-in-display" class="logged-in-user"></span>
                    <button onclick="logout()" class="btn-secondary btn-small">Logout</button>
                </div>
                <div id="auth-buttons">
                    <button onclick="showAuthModal()" class="btn-small">Login / Register</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Browse Tab Content -->
        <div id="browse-tab">
            <!-- Filters Section -->
            <div class="filters-section">
                <div class="filters-row">
                    <div class="search-container">
                        <label for="search-input">Search Records</label>
                        <input type="text" id="search-input" placeholder="Enter search terms..." onkeyup="handleSearchKeyup(event)">
                    </div>
                    
                    <div class="filter-group">
                        <label for="record-type-filter">Record Type</label>
                        <select id="record-type-filter" onchange="applyFilters()">
                            <option value="">All Types</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="sort-by">Sort By</label>
                        <select id="sort-by" onchange="applyFilters()">
                            <option value="inArweaveBlock:desc">Block (Newest)</option>
                            <option value="inArweaveBlock:asc">Block (Oldest)</option>
                            <option value="date:desc">Date (Newest)</option>
                            <option value="date:asc">Date (Oldest)</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="resolve-depth">Resolve Depth</label>
                        <input type="number" id="resolve-depth" value="2" min="0" max="5" onchange="applyFilters()">
                    </div>
                </div>
                
                <div class="filters-row">
                    <div class="filter-group wide">
                        <label>Date Range</label>
                        <div class="date-inputs">
                            <input type="date" id="date-start" onchange="applyFilters()" placeholder="Start Date">
                            <span>to</span>
                            <input type="date" id="date-end" onchange="applyFilters()" placeholder="End Date">
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label for="tag-filter">Filter by Tag</label>
                        <select id="tag-filter" onchange="applyFilters()">
                            <option value="">All Tags</option>
                        </select>
                    </div>
                </div>
                
                <div class="advanced-filters">
                    <div class="toggle-row">
                        <div class="toggle-group">
                            <label>Include Signatures:</label>
                            <div class="toggle-switch" id="include-sigs-toggle" onclick="toggleSwitch('include-sigs-toggle')"></div>
                        </div>
                        
                        <div class="toggle-group">
                            <label>Include Public Keys:</label>
                            <div class="toggle-switch" id="include-pubkeys-toggle" onclick="toggleSwitch('include-pubkeys-toggle')"></div>
                        </div>
                        
                        <button onclick="clearFilters()" class="btn-secondary btn-small">Clear Filters</button>
                        <button onclick="applyFilters()" class="btn-small">Apply Filters</button>
                    </div>
                </div>
            </div>

            <!-- Records Display -->
            <div class="records-container">
                <div id="records-header">
                    <h2>OIP Records</h2>
                    <div id="pagination-info" class="pagination-info"></div>
                </div>
                
                <div id="loading-indicator" class="loading">
                    <div class="spinner"></div>
                    Loading records...
                </div>
                
                <div id="records-grid" class="records-grid hidden"></div>
                
                <div id="no-results" class="no-results hidden">
                    No records found matching your criteria.
                </div>
                
                <div id="load-more-container" class="load-more hidden">
                    <button onclick="loadMoreRecords()" id="load-more-btn">Load More Records</button>
                </div>
            </div>
        </div>

        <!-- Publish Tab Content -->
        <div id="publish-tab" class="hidden">
            <div class="section">
                <h2>Publishing Platform</h2>
                <p>Please log in to access publishing features.</p>
                
                <div id="publishing-content" class="hidden">
                    <div class="filters-row">
                        <button onclick="showCreatorRegistration()">Register Creator</button>
                        <button onclick="showTemplateCreation()">Create Template</button>
                        <button onclick="showRecordPublishing()">Publish Record</button>
                    </div>
                </div>
            </div>

            <!-- Creator Registration -->
            <div id="creator-section" class="section hidden">
                <h2>Creator Registration</h2>
                <div class="form-group">
                    <label for="creator-name">Creator Name:</label>
                    <input type="text" id="creator-name" required>
                </div>
                <div class="form-group">
                    <label for="creator-description">Description:</label>
                    <textarea id="creator-description"></textarea>
                </div>
                <div class="form-group">
                    <label for="creator-email">Email:</label>
                    <input type="email" id="creator-email">
                </div>
                <div class="form-group">
                    <label for="creator-website">Website:</label>
                    <input type="url" id="creator-website">
                </div>
                <button onclick="registerCreator()">Register Creator</button>
                <div id="creator-status" class="error-message hidden"></div>
                <div id="creator-success" class="success-message hidden"></div>
            </div>

            <!-- Template Creation -->
            <div id="template-section" class="section hidden">
                <h2>Template Creation</h2>
                <div class="form-group">
                    <label for="template-name">Template Name:</label>
                    <input type="text" id="template-name" required>
                </div>
                <div class="form-group">
                    <label for="template-recordtype">Record Type:</label>
                    <input type="text" id="template-recordtype" required placeholder="e.g., post, recipe, workout">
                </div>
                <div class="dynamic-fields">
                    <h3>Template Fields</h3>
                    <div id="template-fields">
                        <div class="field-row">
                            <div>
                                <label>Field Name:</label>
                                <input type="text" class="field-name" placeholder="e.g., title, content">
                            </div>
                            <div>
                                <label>Field Type:</label>
                                <select class="field-type">
                                    <option value="string">String</option>
                                    <option value="number">Number</option>
                                    <option value="boolean">Boolean</option>
                                    <option value="enum">Enum</option>
                                    <option value="array">Array</option>
                                </select>
                            </div>
                            <div>
                                <button type="button" onclick="removeField(this)">Remove</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="addTemplateField()">Add Field</button>
                </div>
                <button onclick="createTemplate()">Create Template</button>
                <div id="template-status" class="error-message hidden"></div>
                <div id="template-success" class="success-message hidden"></div>
            </div>

            <!-- Record Publishing -->
            <div id="record-section" class="section hidden">
                <h2>Publish Record</h2>
                <div class="form-group">
                    <label for="record-type">Record Type:</label>
                    <select id="record-type" onchange="loadTemplateFields()">
                        <option value="">Select Record Type</option>
                        <option value="recipe">Recipe</option>
                        <option value="workout">Workout</option>
                        <option value="video">Video</option>
                        <option value="image">Image</option>
                        <option value="post">Post</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="template-select">Template:</label>
                    <select id="template-select">
                        <option value="">Loading templates...</option>
                    </select>
                </div>

                <div id="record-fields" class="dynamic-fields">
                    <div class="loading">Select a record type to see available fields</div>
                </div>
                
                <button onclick="publishRecord()" id="publish-btn" disabled>Publish Record</button>
                <div id="record-status" class="error-message hidden"></div>
                <div id="record-success" class="success-message hidden"></div>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="modal hidden">
        <div class="modal-content">
            <div id="login-form">
                <h2>Login</h2>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required>
                </div>
                <button onclick="login()">Login</button>
                <button onclick="showRegisterForm()" class="btn-secondary">Register Instead</button>
                <button onclick="hideAuthModal()" class="btn-secondary">Cancel</button>
            </div>
            
            <div id="register-form" class="hidden">
                <h2>Register</h2>
                <div class="form-group">
                    <label for="register-email">Email:</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Password:</label>
                    <input type="password" id="register-password" required>
                </div>
                <button onclick="register()">Register</button>
                <button onclick="showLoginForm()" class="btn-secondary">Login Instead</button>
                <button onclick="hideAuthModal()" class="btn-secondary">Cancel</button>
            </div>
            
            <div id="auth-status" class="error-message hidden"></div>
            <div id="auth-success" class="success-message hidden"></div>
        </div>
    </div>

    <script>
        // State management
        let authToken = localStorage.getItem('oip-auth-token');
        let currentUser = localStorage.getItem('oip-user-email');
        let templates = {};
        let defaultTemplates = {};
        let recordTypes = [];
        let currentRecords = [];
        let currentPage = 1;
        let isLoading = false;
        let hasMoreRecords = true;
        let currentFilters = {
            search: '',
            recordType: '',
            sortBy: 'inArweaveBlock:desc',
            resolveDepth: 2,
            dateStart: '',
            dateEnd: '',
            tag: '',
            includeSigs: false,
            includePubKeys: false
        };
        let availableTags = [];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Setup authentication state
            if (authToken && currentUser) {
                showLoggedInState();
                await loadTemplates();
            }
            
            // Load record types for filters
            await loadRecordTypes();
            
            // Load initial records
            await loadRecords(true);
            
            // Setup infinite scroll
            setupInfiniteScroll();
        }

        // Navigation functions
        function showBrowseTab() {
            document.querySelector('.nav-tab.active').classList.remove('active');
            document.querySelector('.nav-tab').classList.add('active');
            document.getElementById('browse-tab').classList.remove('hidden');
            document.getElementById('publish-tab').classList.add('hidden');
        }

        function showPublishTab() {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab')[1].classList.add('active');
            document.getElementById('browse-tab').classList.add('hidden');
            document.getElementById('publish-tab').classList.remove('hidden');
        }

        // Authentication Modal functions
        function showAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
            showLoginForm();
        }

        function hideAuthModal() {
            document.getElementById('auth-modal').classList.add('hidden');
            clearAuthForms();
        }

        function showLoginForm() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        }

        function clearAuthForms() {
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('register-email').value = '';
            document.getElementById('register-password').value = '';
            hideElement('auth-status');
            hideElement('auth-success');
        }

        // Authentication functions
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showMessage('auth-status', 'Please fill in all fields', 'error');
                return;
            }

            try {
                const response = await fetch('/api/user/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    currentUser = email;
                    localStorage.setItem('oip-auth-token', authToken);
                    localStorage.setItem('oip-user-email', currentUser);
                    showLoggedInState();
                    await loadTemplates();
                    showMessage('auth-success', 'Login successful!', 'success');
                    setTimeout(hideAuthModal, 1500);
                } else {
                    showMessage('auth-status', data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showMessage('auth-status', 'Network error: ' + error.message, 'error');
            }
        }

        async function register() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            if (!email || !password) {
                showMessage('auth-status', 'Please fill in all fields', 'error');
                return;
            }

            try {
                const response = await fetch('/api/user/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    currentUser = email;
                    localStorage.setItem('oip-auth-token', authToken);
                    localStorage.setItem('oip-user-email', currentUser);
                    showLoggedInState();
                    await loadTemplates();
                    showMessage('auth-success', 'Registration successful!', 'success');
                    setTimeout(hideAuthModal, 1500);
                } else {
                    showMessage('auth-status', data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showMessage('auth-status', 'Network error: ' + error.message, 'error');
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('oip-auth-token');
            localStorage.removeItem('oip-user-email');
            showLoginState();
        }

        function showLoggedInState() {
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('auth-buttons').classList.add('hidden');
            document.getElementById('publishing-content').classList.remove('hidden');
            document.getElementById('logged-in-display').textContent = currentUser;
        }

        function showLoginState() {
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('auth-buttons').classList.remove('hidden');
            document.getElementById('publishing-content').classList.add('hidden');
            hideAllPublishingSections();
        }

        // Core browsing functionality
        async function loadRecords(reset = false) {
            if (isLoading) return;
            
            isLoading = true;
            const loadingEl = document.getElementById('loading-indicator');
            const recordsGrid = document.getElementById('records-grid');
            const noResults = document.getElementById('no-results');
            
            if (reset) {
                currentPage = 1;
                currentRecords = [];
                recordsGrid.innerHTML = '';
                loadingEl.classList.remove('hidden');
                recordsGrid.classList.add('hidden');
                noResults.classList.add('hidden');
            }

            try {
                const params = buildApiParams();
                const response = await fetch(`https://api.oip.onl/api/records?${params}`);
                const data = await response.json();
                
                if (data.records) {
                    if (reset) {
                        currentRecords = data.records;
                    } else {
                        currentRecords = [...currentRecords, ...data.records];
                    }
                    
                    displayRecords(data.records, !reset);
                    updatePaginationInfo(data);
                    
                    // Update tags if available
                    if (data.tagSummary) {
                        updateTagFilter(data.tagSummary);
                    }
                    
                    hasMoreRecords = data.records.length === 12; // Check if we got a full page
                } else {
                    if (reset) {
                        showNoResults();
                    }
                }
                
            } catch (error) {
                console.error('Error loading records:', error);
                showMessage('records-header', 'Error loading records: ' + error.message, 'error');
            } finally {
                isLoading = false;
                loadingEl.classList.add('hidden');
                updateLoadMoreButton();
            }
        }

        function buildApiParams() {
            const params = new URLSearchParams({
                limit: '12',
                page: currentPage.toString(),
                sortBy: currentFilters.sortBy,
                resolveDepth: currentFilters.resolveDepth.toString(),
                summarizeTags: 'true',
                tagCount: '25',
                includeSigs: currentFilters.includeSigs.toString(),
                includePubKeys: currentFilters.includePubKeys.toString()
            });

            if (currentFilters.search) {
                params.append('search', currentFilters.search.replace(/\s+/g, '+'));
            }
            
            if (currentFilters.recordType) {
                params.append('recordType', currentFilters.recordType);
            }
            
            if (currentFilters.dateStart) {
                params.append('dateStart', dateToUnixTime(currentFilters.dateStart));
            }
            
            if (currentFilters.dateEnd) {
                params.append('dateEnd', dateToUnixTime(currentFilters.dateEnd));
            }
            
            if (currentFilters.tag) {
                params.append('tags', currentFilters.tag);
            }

            return params.toString();
        }

        // Display and utility functions
        function displayRecords(records, append = false) {
            const grid = document.getElementById('records-grid');
            
            if (!append) {
                grid.innerHTML = '';
            }
            
            records.forEach(record => {
                const card = createRecordCard(record);
                grid.appendChild(card);
            });
            
            grid.classList.remove('hidden');
        }

        // Media rendering functions
        function renderMediaContent(record, recordType, specificData) {
            let mediaHtml = '';
            
            // Handle direct media records (image, audio, video, text)
            if (['image', 'audio', 'video', 'text'].includes(recordType)) {
                mediaHtml += renderDirectMedia(specificData, recordType);
            }
            
            // Handle post records with embedded media
            if (recordType === 'post' && specificData) {
                mediaHtml += renderPostMedia(specificData);
            }
            
            // Handle recipe and workout records with media in ingredients/exercises
            if (['recipe', 'workout'].includes(recordType) && specificData) {
                mediaHtml += renderRecipeWorkoutMedia(specificData, recordType);
            }
            
            return mediaHtml ? `<div class="media-content">${mediaHtml}</div>` : '';
        }
        
        function renderDirectMedia(data, type) {
            if (!data || !data.webUrl) return '';
            
            const webUrl = data.webUrl;
            const contentType = data.contentType || '';
            
            switch (type) {
                case 'image':
                    return `<div class="media-item">
                        <img src="${webUrl}" alt="Image" style="max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0;" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display: none; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                            <a href="${webUrl}" target="_blank">üì∏ View Image</a>
                        </div>
                    </div>`;
                    
                case 'audio':
                    return `<div class="media-item">
                        <audio controls style="width: 100%; margin: 10px 0;">
                            <source src="${webUrl}" type="${contentType}">
                            <a href="${webUrl}" target="_blank">üéµ Play Audio</a>
                        </audio>
                    </div>`;
                    
                case 'video':
                    return `<div class="media-item">
                        <video controls style="width: 100%; max-height: 300px; margin: 10px 0;">
                            <source src="${webUrl}" type="${contentType}">
                            <a href="${webUrl}" target="_blank">üé• Play Video</a>
                        </video>
                    </div>`;
                    
                case 'text':
                    return `<div class="media-item">
                        <div class="text-preview" style="margin: 10px 0;">
                            <button onclick="loadTextContent('${webUrl}', this)" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üìÑ View Text Content
                            </button>
                            <div class="text-content" style="display: none; margin-top: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px; max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>`;
                    
                default:
                    return `<div class="media-item">
                        <a href="${webUrl}" target="_blank" style="display: inline-block; padding: 8px 16px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px; margin: 5px 0;">
                            üîó View Content
                        </a>
                    </div>`;
            }
        }
        
        function renderPostMedia(postData) {
            let html = '';
            
            // Main article web URL (external link) - this should open in new tab
            if (postData.webUrl) {
                html += `<div class="media-item">
                    <a href="${postData.webUrl}" target="_blank" rel="noopener noreferrer" style="display: inline-block; padding: 8px 16px; background: #28a745; color: white; text-decoration: none; border-radius: 4px; margin: 5px 0;">
                        üåê Read Original Article
                    </a>
                </div>`;
            }
            
            // Article text (dref resolved)
            if (postData.articleText?.data?.text?.webUrl) {
                html += renderDirectMedia(postData.articleText.data.text, 'text');
            }
            
            // Featured image (dref resolved)
            if (postData.featuredImage?.data?.image?.webUrl) {
                html += renderDirectMedia(postData.featuredImage.data.image, 'image');
            }
            
            // Audio items array
            if (postData.audioItems && Array.isArray(postData.audioItems)) {
                postData.audioItems.forEach((audioItem, index) => {
                    if (audioItem?.data?.audio?.webUrl) {
                        html += `<div class="media-item">
                            <label style="font-weight: bold; display: block; margin: 10px 0 5px 0;">Audio ${index + 1}:</label>
                            ${renderDirectMedia(audioItem.data.audio, 'audio')}
                        </div>`;
                    }
                });
            }
            
            // Video items array
            if (postData.videoItems && Array.isArray(postData.videoItems)) {
                postData.videoItems.forEach((videoItem, index) => {
                    if (videoItem?.data?.video?.webUrl) {
                        html += `<div class="media-item">
                            <label style="font-weight: bold; display: block; margin: 10px 0 5px 0;">Video ${index + 1}:</label>
                            ${renderDirectMedia(videoItem.data.video, 'video')}
                        </div>`;
                    }
                });
            }
            
            // Image items array
            if (postData.imageItems && Array.isArray(postData.imageItems)) {
                postData.imageItems.forEach((imageItem, index) => {
                    if (imageItem?.data?.image?.webUrl) {
                        html += `<div class="media-item">
                            <label style="font-weight: bold; display: block; margin: 10px 0 5px 0;">Image ${index + 1}:</label>
                            ${renderDirectMedia(imageItem.data.image, 'image')}
                        </div>`;
                    }
                });
            }
            
            return html;
        }
        
        function renderRecipeWorkoutMedia(data, type) {
            let html = '';
            
            // Handle ingredient/exercise references that might contain media
            const items = type === 'recipe' ? data.ingredient : data.exercise;
            if (items && Array.isArray(items)) {
                items.forEach((item, index) => {
                    if (item?.data) {
                        // Check if the referenced item has media
                        Object.keys(item.data).forEach(key => {
                            if (key !== 'basic') {
                                const itemData = item.data[key];
                                if (itemData?.webUrl) {
                                    const itemType = key;
                                    if (['image', 'audio', 'video', 'text'].includes(itemType)) {
                                        html += `<div class="media-item">
                                            <label style="font-weight: bold; display: block; margin: 10px 0 5px 0;">
                                                ${type === 'recipe' ? 'Ingredient' : 'Exercise'} ${index + 1} ${itemType}:
                                            </label>
                                            ${renderDirectMedia(itemData, itemType)}
                                        </div>`;
                                    }
                                }
                            }
                        });
                    }
                });
            }
            
            return html;
        }
        
        // Load text content dynamically
        async function loadTextContent(url, button) {
            const contentDiv = button.nextElementSibling;
            
            if (contentDiv.style.display === 'none') {
                try {
                    button.textContent = 'Loading...';
                    button.disabled = true;
                    
                    const response = await fetch(url);
                    const text = await response.text();
                    
                    contentDiv.innerHTML = `
                        <div style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 14px;">
                            ${escapeHtml(text)}
                        </div>
                        <button onclick="this.parentElement.style.display='none'; this.parentElement.previousElementSibling.textContent='üìÑ View Text Content'; this.parentElement.previousElementSibling.disabled=false;" 
                                style="margin-top: 10px; padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Hide
                        </button>
                    `;
                    contentDiv.style.display = 'block';
                    button.textContent = 'üìÑ Text Loaded';
                } catch (error) {
                    contentDiv.innerHTML = `<div style="color: #dc3545;">Error loading text content: ${error.message}</div>`;
                    contentDiv.style.display = 'block';
                    button.textContent = '‚ùå Failed to Load';
                }
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function createRecordCard(record) {
            const card = document.createElement('div');
            card.className = 'record-card';
            
            // Get record type from template or data
            const recordType = getRecordType(record);
            const basicData = record.data?.basic || {};
            const specificData = record.data?.[recordType] || {};
            
            card.innerHTML = `
                <div class="record-header">
                    <div class="record-type">${recordType}</div>
                    <div class="record-block">Block: ${record.oip?.inArweaveBlock || 'Unknown'}</div>
                </div>
                <div class="record-title">${basicData.name || 'Unnamed Record'}</div>
                <div class="record-content">
                    ${basicData.description || getContentPreview(specificData) || 'No description available'}
                </div>
                ${renderMediaContent(record, recordType, specificData)}
                <div class="record-meta">
                    <div>DID: ${record.oip?.didTx || 'Unknown'}</div>
                    <div>Date: ${formatDate(basicData.date)}</div>
                    ${basicData.webUrl ? `<div><a href="${basicData.webUrl}" target="_blank">View Source</a></div>` : ''}
                </div>
                ${createTagsDisplay(basicData.tagItems)}
            `;
            
            return card;
        }

        function getRecordType(record) {
            // Try to get from data structure
            if (record.data) {
                const keys = Object.keys(record.data);
                for (const key of keys) {
                    if (key !== 'basic' && typeof record.data[key] === 'object') {
                        return key;
                    }
                }
            }
            return 'unknown';
        }

        function getContentPreview(data) {
            if (!data) return '';
            
            // Try common content fields
            if (data.content) return truncateText(data.content, 150);
            if (data.articleText) return truncateText(data.articleText, 150);
            if (data.description) return truncateText(data.description, 150);
            
            return '';
        }

        function createTagsDisplay(tags) {
            if (!tags || !Array.isArray(tags) || tags.length === 0) return '';
            
            const tagsHtml = tags.slice(0, 5).map(tag => 
                `<span class="tag" onclick="filterByTag('${tag}')">${tag}</span>`
            ).join('');
            
            return `<div class="tags-container">${tagsHtml}</div>`;
        }

        // Filter and search functions
        function applyFilters() {
            collectFilters();
            loadRecords(true);
        }

        function collectFilters() {
            currentFilters.search = document.getElementById('search-input').value.trim();
            currentFilters.recordType = document.getElementById('record-type-filter').value;
            currentFilters.sortBy = document.getElementById('sort-by').value;
            currentFilters.resolveDepth = parseInt(document.getElementById('resolve-depth').value) || 2;
            currentFilters.dateStart = document.getElementById('date-start').value;
            currentFilters.dateEnd = document.getElementById('date-end').value;
            currentFilters.tag = document.getElementById('tag-filter').value;
            currentFilters.includeSigs = document.getElementById('include-sigs-toggle').classList.contains('active');
            currentFilters.includePubKeys = document.getElementById('include-pubkeys-toggle').classList.contains('active');
        }

        function handleSearchKeyup(event) {
            if (event.key === 'Enter') {
                applyFilters();
            }
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('record-type-filter').value = '';
            document.getElementById('sort-by').value = 'inArweaveBlock:desc';
            document.getElementById('resolve-depth').value = '2';
            document.getElementById('date-start').value = '';
            document.getElementById('date-end').value = '';
            document.getElementById('tag-filter').value = '';
            document.getElementById('include-sigs-toggle').classList.remove('active');
            document.getElementById('include-pubkeys-toggle').classList.remove('active');
            applyFilters();
        }

        function filterByTag(tag) {
            document.getElementById('tag-filter').value = tag;
            applyFilters();
        }

        function toggleSwitch(elementId) {
            document.getElementById(elementId).classList.toggle('active');
        }

        // Load templates from API
        async function loadTemplates() {
            try {
                const response = await fetch('/api/templates?limit=100');
                const data = await response.json();
                
                if (data.templates) {
                    templates = {};
                    data.templates.forEach(template => {
                        const recordType = template.data.recordType || template.data.template || 'unknown';
                        if (!templates[recordType]) {
                            templates[recordType] = [];
                        }
                        templates[recordType].push(template);
                    });
                    
                    // Load default templates
                    defaultTemplates = {
                        basic: "-9DirnjVO1FlbEW1lN8jITBESrTsQKEM_BoZ1ey_0mk",
                        creatorRegistration: "BKVvTSXmmJni-L82irZfPFXWWJLBcdvbxS34jP1FTG8",
                        post: "op6y-d_6bqivJ2a2oWQnbylD4X_LH6eQyR6rCGqtVZ8",
                        recipe: "46Ui_ifw5LnrRmf_o2zWwikNxgXsXk3sswPtbcJCzlc",
                        workout: "T_16JOpyRKt0dmuZikHPpDcIhwh4DR1ZspHU4BKa-qE",
                        video: "G73WplyxpNDOgDSFO6CP3O6hZXq8kNJXxkCqx3sgd1s",
                        image: "AkZnE1VckJJlRamgNJuIGE7KrYwDcCciWOMrMh68V4o"
                    };
                }
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }

        async function loadRecordTypes() {
            try {
                const response = await fetch('https://api.oip.onl/api/templates?limit=25&page=1');
                const data = await response.json();
                
                if (data.templates) {
                    const typeSet = new Set();
                    data.templates.forEach(template => {
                        if (template.data?.template) {
                            typeSet.add(template.data.template);
                        }
                    });
                    
                    recordTypes = Array.from(typeSet).sort();
                    populateRecordTypeFilter();
                }
            } catch (error) {
                console.error('Error loading record types:', error);
            }
        }

        function populateRecordTypeFilter() {
            const select = document.getElementById('record-type-filter');
            select.innerHTML = '<option value="">All Types</option>';
            
            recordTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                select.appendChild(option);
            });
        }

        // Utility functions
        function truncateText(text, length) {
            if (!text) return '';
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString();
        }

        function dateToUnixTime(dateString) {
            if (!dateString) return '';
            return Math.floor(new Date(dateString).getTime() / 1000).toString();
        }

        function updatePaginationInfo(data) {
            const info = document.getElementById('pagination-info');
            info.textContent = `Showing ${currentRecords.length} of ${data.totalRecords || 'many'} records`;
        }

        function updateTagFilter(tagSummary) {
            const select = document.getElementById('tag-filter');
            const currentValue = select.value;
            select.innerHTML = '<option value="">All Tags</option>';
            
            tagSummary.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.tag;
                option.textContent = `${tag.tag} (${tag.count})`;
                select.appendChild(option);
            });
            
            select.value = currentValue;
        }

        function showNoResults() {
            document.getElementById('records-grid').classList.add('hidden');
            document.getElementById('no-results').classList.remove('hidden');
        }

        function updateLoadMoreButton() {
            const container = document.getElementById('load-more-container');
            const button = document.getElementById('load-more-btn');
            
            if (hasMoreRecords && currentRecords.length > 0) {
                container.classList.remove('hidden');
                button.disabled = isLoading;
                button.textContent = isLoading ? 'Loading...' : 'Load More Records';
            } else {
                container.classList.add('hidden');
            }
        }

        function loadMoreRecords() {
            if (!hasMoreRecords || isLoading) return;
            currentPage++;
            loadRecords(false);
        }

        function setupInfiniteScroll() {
            window.addEventListener('scroll', () => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
                    loadMoreRecords();
                }
            });
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = type === 'error' ? 'error-message' : 'success-message';
            element.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => element.classList.add('hidden'), 3000);
            }
        }

        function hideElement(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // Publishing navigation functions
        function hideAllPublishingSections() {
            document.getElementById('creator-section').classList.add('hidden');
            document.getElementById('template-section').classList.add('hidden');
            document.getElementById('record-section').classList.add('hidden');
        }

        function showCreatorRegistration() {
            hideAllPublishingSections();
            document.getElementById('creator-section').classList.remove('hidden');
        }

        function showTemplateCreation() {
            hideAllPublishingSections();
            document.getElementById('template-section').classList.remove('hidden');
        }

        function showRecordPublishing() {
            hideAllPublishingSections();
            document.getElementById('record-section').classList.remove('hidden');
        }

        // Creator registration
        async function registerCreator() {
            const name = document.getElementById('creator-name').value;
            const description = document.getElementById('creator-description').value;
            const email = document.getElementById('creator-email').value;
            const website = document.getElementById('creator-website').value;

            if (!name) {
                showMessage('creator-status', 'Please enter a creator name', 'error');
                return;
            }

            const creatorData = {
                basic: {
                    name: name,
                    description: description,
                    language: 'en',
                    date: Math.floor(Date.now() / 1000),
                    nsfw: false
                },
                creatorRegistration: {
                    email: email || currentUser,
                    website: website,
                    verified: false
                }
            };

            try {
                const response = await fetch('/api/creators/newCreator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(creatorData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('creator-success', `Creator registered successfully! Transaction ID: ${data.transactionId}`, 'success');
                    // Clear form
                    document.getElementById('creator-name').value = '';
                    document.getElementById('creator-description').value = '';
                    document.getElementById('creator-email').value = '';
                    document.getElementById('creator-website').value = '';
                } else {
                    showMessage('creator-status', data.error || 'Failed to register creator', 'error');
                }
            } catch (error) {
                showMessage('creator-status', 'Network error: ' + error.message, 'error');
            }
        }

        // Template creation functions
        function addTemplateField() {
            const fieldsContainer = document.getElementById('template-fields');
            const fieldRow = document.createElement('div');
            fieldRow.className = 'field-row';
            fieldRow.innerHTML = `
                <div>
                    <label>Field Name:</label>
                    <input type="text" class="field-name" placeholder="e.g., title, content">
                </div>
                <div>
                    <label>Field Type:</label>
                    <select class="field-type">
                        <option value="string">String</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                        <option value="enum">Enum</option>
                        <option value="array">Array</option>
                    </select>
                </div>
                <div>
                    <button type="button" onclick="removeField(this)">Remove</button>
                </div>
            `;
            fieldsContainer.appendChild(fieldRow);
        }

        function removeField(button) {
            button.closest('.field-row').remove();
        }

        async function createTemplate() {
            const templateName = document.getElementById('template-name').value;
            const recordType = document.getElementById('template-recordtype').value;

            if (!templateName || !recordType) {
                showMessage('template-status', 'Please fill in template name and record type', 'error');
                return;
            }

            const fieldRows = document.querySelectorAll('#template-fields .field-row');
            const templateFields = {};

            fieldRows.forEach(row => {
                const fieldName = row.querySelector('.field-name').value;
                const fieldType = row.querySelector('.field-type').value;
                
                if (fieldName && fieldType) {
                    templateFields[fieldName] = fieldType;
                }
            });

            if (Object.keys(templateFields).length === 0) {
                showMessage('template-status', 'Please add at least one field', 'error');
                return;
            }

            const templateData = {
                template: templateName,
                recordType: recordType,
                fields: JSON.stringify(templateFields)
            };

            try {
                const response = await fetch('/api/templates/newTemplate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(templateData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('template-success', `Template created successfully! Transaction ID: ${data.newTemplate.transactionId}`, 'success');
                    // Clear form and reload templates
                    document.getElementById('template-name').value = '';
                    document.getElementById('template-recordtype').value = '';
                    await loadTemplates();
                } else {
                    showMessage('template-status', data.error || 'Failed to create template', 'error');
                }
            } catch (error) {
                showMessage('template-status', 'Network error: ' + error.message, 'error');
            }
        }

        // Record publishing functions
        function loadTemplateFields() {
            const recordType = document.getElementById('record-type').value;
            const fieldsContainer = document.getElementById('record-fields');
            const publishBtn = document.getElementById('publish-btn');
            
            if (!recordType) {
                fieldsContainer.innerHTML = '<div class="loading">Select a record type to see available fields</div>';
                publishBtn.disabled = true;
                return;
            }

            // Load template selector
            const templateSelect = document.getElementById('template-select');
            templateSelect.innerHTML = '<option value="">Select a template</option>';
            
            if (templates[recordType]) {
                templates[recordType].forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.oip.didTx;
                    option.textContent = template.data.template || template.oip.didTx;
                    templateSelect.appendChild(option);
                });
            }

            // Add default template option
            if (defaultTemplates[recordType]) {
                const option = document.createElement('option');
                option.value = `did:arweave:${defaultTemplates[recordType]}`;
                option.textContent = `Default ${recordType} template`;
                option.selected = true;
                templateSelect.appendChild(option);
            }

            // Create basic fields for the record type
            fieldsContainer.innerHTML = createRecordFields(recordType);
            publishBtn.disabled = false;
        }

        function createRecordFields(recordType) {
            let fieldsHTML = '<h3>Basic Information</h3>';
            
            // Basic fields common to all records
            fieldsHTML += `
                <div class="form-group">
                    <label>Name/Title:</label>
                    <input type="text" id="basic-name" required>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="basic-description"></textarea>
                </div>
                <div class="form-group">
                    <label>Tags (comma-separated):</label>
                    <input type="text" id="basic-tags" placeholder="tag1, tag2, tag3">
                </div>
            `;

            // Simplified record-specific fields
            fieldsHTML += `<h3>${recordType.charAt(0).toUpperCase() + recordType.slice(1)} Fields</h3>`;
            
            if (recordType === 'post') {
                fieldsHTML += `
                    <div class="form-group">
                        <label>Article Text:</label>
                        <textarea id="post-articletext" required placeholder="Main article content"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Byline Writer:</label>
                        <input type="text" id="post-bylinewriter" placeholder="Author name">
                    </div>
                `;
            } else {
                fieldsHTML += `
                    <div class="form-group">
                        <label>Content:</label>
                        <textarea id="record-content" placeholder="Enter ${recordType} content"></textarea>
                    </div>
                `;
            }

            return fieldsHTML;
        }

        async function publishRecord() {
            const recordType = document.getElementById('record-type').value;
            
            if (!recordType) {
                showMessage('record-status', 'Please select a record type', 'error');
                return;
            }

            // Collect basic data
            const basicData = {
                name: document.getElementById('basic-name').value,
                description: document.getElementById('basic-description').value,
                language: 'en',
                tagItems: document.getElementById('basic-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                nsfw: false,
                date: Math.floor(Date.now() / 1000)
            };

            if (!basicData.name) {
                showMessage('record-status', 'Please enter a name/title', 'error');
                return;
            }

            // Simplified record data collection
            let recordData = { basic: basicData };
            let endpoint = `/api/publish/new${recordType.charAt(0).toUpperCase() + recordType.slice(1)}`;

            if (recordType === 'post') {
                recordData.post = {
                    articleText: document.getElementById('post-articletext').value,
                    bylineWriter: document.getElementById('post-bylinewriter').value,
                    webUrl: '',
                    bylineWritersTitle: '',
                    bylineWritersLocation: '',
                    featuredImage: '',
                    imageItems: [],
                    imageCaptionItems: [],
                    videoItems: [],
                    audioItems: [],
                    audioCaptionItems: [],
                    replyTo: ''
                };
                
                if (!recordData.post.articleText) {
                    showMessage('record-status', 'Please enter the article text', 'error');
                    return;
                }
            } else {
                // For other record types, use generic content field
                const content = document.getElementById('record-content').value;
                recordData[recordType] = { content: content };
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(recordData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('record-success', `${recordType} published successfully! Transaction ID: ${data.transactionId}`, 'success');
                    // Clear the form
                    document.getElementById('record-fields').innerHTML = '<div class="loading">Select a record type to see available fields</div>';
                    document.getElementById('record-type').value = '';
                    document.getElementById('publish-btn').disabled = true;
                    
                    // Refresh the browse tab to show new record
                    if (currentRecords.length > 0) {
                        loadRecords(true);
                    }
                } else {
                    showMessage('record-status', data.error || `Failed to publish ${recordType}`, 'error');
                }
            } catch (error) {
                showMessage('record-status', 'Network error: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html> 
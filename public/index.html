<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Assistant - Chatterbox TTS</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .chatterbox-controls {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #4CAF50;
        }
        .chatterbox-title {
            color: #4CAF50;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .voice-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        .control-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
        }
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .voice-preview {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé≠ AI Voice Assistant - Chatterbox TTS</h1>
            <p>Powered by Resemble AI's neural TTS with emotion control</p>
        </header>
        
        <main>
            <!-- Chatterbox TTS Controls -->
            <div class="chatterbox-controls">
                <h3 class="chatterbox-title">
                    <span class="status-indicator"></span>
                    Chatterbox Voice Engine (High Quality)
                </h3>
                
                <div class="voice-controls">
                    <div class="control-group">
                        <label for="voice-gender">Voice Gender:</label>
                        <select id="voice-gender" onchange="updateVoiceSettings()">
                            <option value="female" selected>Female Voice</option>
                            <option value="male">Male Voice</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="voice-emotion">Emotional Tone:</label>
                        <select id="voice-emotion" onchange="updateVoiceSettings()">
                            <option value="expressive" selected>Expressive & Engaging</option>
                            <option value="calm">Calm & Measured</option>
                            <option value="dramatic">Dramatic & Intense</option>
                            <option value="neutral">Neutral & Balanced</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="tts-enabled" checked onchange="toggleTTS()">
                            Enable Chatterbox TTS
                                                  </label>
                      </div>
                    
                    <div class="control-group">
                        <label for="emotion-slider">Emotion Level: <span id="emotion-value">70%</span></label>
                        <div class="slider-container">
                            <span>üòê</span>
                            <input type="range" id="emotion-slider" class="slider" min="0" max="100" value="70" oninput="updateEmotion(this.value)">
                            <span>üé≠</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="pacing-slider">Speech Pacing: <span id="pacing-value">40%</span></label>
                        <div class="slider-container">
                            <span>üêå</span>
                            <input type="range" id="pacing-slider" class="slider" min="30" max="70" value="40" oninput="updatePacing(this.value)">
                            <span>üöÄ</span>
                        </div>
                    </div>
                    
                    <!-- Voice Cloning Section -->
                    <div style="margin-top: 15px; border-top: 2px solid #4CAF50; padding-top: 15px;">
                        <h4 style="color: #4CAF50; margin-bottom: 10px;">üé§ Voice Cloning (Zero-Shot)</h4>
                        
                        <div class="control-group">
                            <label for="voice-sample-upload">Upload Voice Sample (WAV/MP3):</label>
                            <input type="file" id="voice-sample-upload" accept="audio/*" onchange="handleVoiceSampleUpload(this)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <small style="color: #666;">Upload a 3-10 second audio sample to clone any voice</small>
                        </div>
                        
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="voice-cloning-enabled" onchange="toggleVoiceCloning()">
                                Enable Voice Cloning Mode
                            </label>
                        </div>
                        
                        <div id="voice-clone-status" style="padding: 8px; background: #f0f0f0; border-radius: 5px; font-size: 12px; color: #666;">
                            No voice sample uploaded. Using default Chatterbox voices.
                        </div>
                    </div>
                </div>
                
                <div class="voice-preview" id="voice-preview">
                    Current: Female expressive voice with 70% emotion and 30% pacing speed. Engaging female voice with natural expressiveness. ‚ú® Optimized for engaging, natural speech.
                </div>
            </div>
            
            <!-- Voice Assistant Interface -->
            <div id="voice-assistant-root">
                <div class="waveform-container">
                    <canvas id="waveform"></canvas>
                </div>
                
                <div class="controls">
                    <button id="microphone-btn" class="mic-btn" onclick="toggleMicrophone()">
                        <span class="mic-icon">üéôÔ∏è</span>
                        <span id="mic-status">Click to Start</span>
                    </button>
                    <button id="test-voice-btn" class="control-btn" onclick="testChatterboxVoice()">
                        <span>üéµ Test Voice</span>
                    </button>
                    <button id="test-clone-btn" class="control-btn" onclick="testVoiceCloning()" style="display: none;">
                        <span>üé§ Test Clone</span>
                    </button>
                    <button id="transcript-btn" class="control-btn" onclick="toggleTranscript()">
                        <span>üìÑ Transcript</span>
                    </button>
                    <button id="stop-btn" class="control-btn" onclick="stopAll()">
                        <span>‚èπÔ∏è Stop</span>
                    </button>
                </div>
            </div>
            
            <!-- Status Display -->
            <div id="status-display" style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                <strong>Status:</strong> <span id="current-status">Chatterbox TTS Ready</span>
            </div>
        </main>
        
        <div id="transcript-panel" class="transcript-panel hidden">
            <div class="transcript-header">
                <h2>Conversation Transcript</h2>
                <button id="close-transcript" class="close-btn" onclick="toggleTranscript()">‚úï</button>
            </div>
            <div id="transcript-content" class="transcript-content"></div>
        </div>
    </div>

    <script>
        // Chatterbox TTS Configuration - High Quality Defaults
        const chatterboxConfig = {
            enabled: true,
            gender: 'female',        // Default to female voice
            emotion: 'expressive',   // Default to expressive tone
            exaggeration: 0.7,       // 70% emotion for engaging speech
            cfg_weight: 0.3,         // Lower weight for better pacing with expressive tone
            baseUrl: window.location.origin, // Use current server
            fallbackTTS: 'edge',     // Fallback to Edge TTS if needed
            voiceCloning: {
                enabled: false,
                audioFile: null,
                fileName: null
            }
        };

        // Voice configuration matrix: Gender + Emotion combinations
        const voiceMatrix = {
            'female': {
                'expressive': { exaggeration: 0.7, cfg_weight: 0.3, description: 'Engaging female voice with natural expressiveness' },
                'calm': { exaggeration: 0.2, cfg_weight: 0.6, description: 'Soothing female voice with measured pacing' },
                'dramatic': { exaggeration: 0.9, cfg_weight: 0.2, description: 'Intense female voice with maximum emotion' },
                'neutral': { exaggeration: 0.5, cfg_weight: 0.5, description: 'Balanced female voice for general use' }
            },
            'male': {
                'expressive': { exaggeration: 0.6, cfg_weight: 0.3, description: 'Dynamic male voice with controlled emotion' },
                'calm': { exaggeration: 0.3, cfg_weight: 0.6, description: 'Deep, calming male voice with slow delivery' },
                'dramatic': { exaggeration: 0.8, cfg_weight: 0.2, description: 'Powerful male voice with commanding presence' },
                'neutral': { exaggeration: 0.4, cfg_weight: 0.5, description: 'Professional male voice for clear communication' }
            }
        };

        let isListening = false;
        let currentAudio = null;

        // Initialize Chatterbox TTS on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üé≠ Initializing Chatterbox TTS Voice Assistant...');
            checkChatterboxStatus();
            updateVoiceSettings(); // This will set sliders and update preview
        });

        // Check if Chatterbox TTS service is available
        async function checkChatterboxStatus() {
            try {
                const response = await fetch('/api/voice/health');
                const data = await response.json();
                
                if (data.chatterbox_available) {
                    updateStatus('‚úÖ Chatterbox TTS Ready - High Quality Neural Voice Active');
                    document.querySelector('.status-indicator').style.background = '#4CAF50';
                } else {
                    updateStatus('‚ö†Ô∏è Chatterbox TTS Unavailable - Using Fallback Voice Engine');
                    document.querySelector('.status-indicator').style.background = '#FF9800';
                }
            } catch (error) {
                console.error('Failed to check Chatterbox status:', error);
                updateStatus('‚ùå Voice Service Connection Error');
                document.querySelector('.status-indicator').style.background = '#f44336';
            }
        }

        // Update voice settings based on gender and emotion selection
        function updateVoiceSettings() {
            const gender = document.getElementById('voice-gender').value;
            const emotion = document.getElementById('voice-emotion').value;
            const config = voiceMatrix[gender][emotion];
            
            chatterboxConfig.gender = gender;
            chatterboxConfig.emotion = emotion;
            chatterboxConfig.exaggeration = config.exaggeration;
            chatterboxConfig.cfg_weight = config.cfg_weight;
            
            // Update sliders to match configuration
            document.getElementById('emotion-slider').value = Math.round(config.exaggeration * 100);
            document.getElementById('pacing-slider').value = Math.round(config.cfg_weight * 100);
            
            updateEmotion(Math.round(config.exaggeration * 100));
            updatePacing(Math.round(config.cfg_weight * 100));
            updateVoicePreview();
            
            console.log('üéµ Voice settings updated:', gender, emotion, config);
        }

        // Update emotion level
        function updateEmotion(value) {
            chatterboxConfig.exaggeration = value / 100;
            document.getElementById('emotion-value').textContent = value + '%';
            updateVoicePreview();
        }

        // Update pacing
        function updatePacing(value) {
            chatterboxConfig.cfg_weight = value / 100;
            document.getElementById('pacing-value').textContent = value + '%';
            updateVoicePreview();
        }

        // Toggle TTS on/off
        function toggleTTS() {
            chatterboxConfig.enabled = document.getElementById('tts-enabled').checked;
            updateStatus(chatterboxConfig.enabled ? 'Chatterbox TTS Enabled' : 'TTS Disabled');
            updateVoicePreview();
        }

        // Handle voice sample file upload
        function handleVoiceSampleUpload(input) {
            const file = input.files[0];
            if (!file) {
                chatterboxConfig.voiceCloning.audioFile = null;
                chatterboxConfig.voiceCloning.fileName = null;
                updateVoiceCloneStatus('No voice sample uploaded. Using default Chatterbox voices.');
                return;
            }

            // Validate file type
            const validTypes = ['audio/wav', 'audio/mpeg', 'audio/mp3', 'audio/ogg', 'audio/webm'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload a valid audio file (WAV, MP3, OGG, or WebM)');
                input.value = '';
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB');
                input.value = '';
                return;
            }

            chatterboxConfig.voiceCloning.audioFile = file;
            chatterboxConfig.voiceCloning.fileName = file.name;
            
            updateVoiceCloneStatus(`Voice sample loaded: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB). Enable voice cloning to use it.`);
            
            console.log('üé§ Voice sample uploaded:', file.name, file.type);
        }

        // Toggle voice cloning mode
        function toggleVoiceCloning() {
            const enabled = document.getElementById('voice-cloning-enabled').checked;
            
            if (enabled && !chatterboxConfig.voiceCloning.audioFile) {
                alert('Please upload a voice sample first!');
                document.getElementById('voice-cloning-enabled').checked = false;
                return;
            }
            
            chatterboxConfig.voiceCloning.enabled = enabled;
            
            // Show/hide voice cloning test button
            const testCloneBtn = document.getElementById('test-clone-btn');
            if (enabled) {
                testCloneBtn.style.display = 'inline-block';
                updateVoiceCloneStatus(`‚úÖ Voice cloning active with ${chatterboxConfig.voiceCloning.fileName}. Your AI will speak in the uploaded voice!`);
                updateStatus('üé§ Voice cloning mode enabled - AI will use your uploaded voice sample');
            } else {
                testCloneBtn.style.display = 'none';
                updateVoiceCloneStatus(`Voice sample available: ${chatterboxConfig.voiceCloning.fileName}. Enable voice cloning to use it.`);
                updateStatus('üé≠ Using default Chatterbox voices');
            }
            
            updateVoicePreview();
        }

        // Test voice cloning specifically
        async function testVoiceCloning() {
            if (!chatterboxConfig.voiceCloning.enabled || !chatterboxConfig.voiceCloning.audioFile) {
                updateStatus('‚ùå Voice cloning not enabled or no audio file uploaded');
                return;
            }

            const testText = `Hello! This is a test of voice cloning using your uploaded voice sample. I should now sound like the person in your audio file, with ${Math.round(chatterboxConfig.exaggeration * 100)} percent emotional expression.`;
            
            updateStatus('üé§ Testing voice cloning...');
            
            try {
                await synthesizeWithChatterbox(testText);
                updateStatus('‚úÖ Voice cloning test completed successfully!');
            } catch (error) {
                console.error('Voice cloning test failed:', error);
                updateStatus('‚ùå Voice cloning test failed - check console for details');
            }
        }

        // Update voice clone status display
        function updateVoiceCloneStatus(message) {
            document.getElementById('voice-clone-status').textContent = message;
        }

        // Update voice preview description
        function updateVoicePreview() {
            const gender = chatterboxConfig.gender;
            const emotion = chatterboxConfig.emotion;
            const emotionLevel = Math.round(chatterboxConfig.exaggeration * 100);
            const pacing = Math.round(chatterboxConfig.cfg_weight * 100);
            
            if (!chatterboxConfig.enabled) {
                document.getElementById('voice-preview').textContent = '‚ö†Ô∏è TTS is currently disabled.';
                return;
            }
            
            // Voice cloning mode
            if (chatterboxConfig.voiceCloning.enabled && chatterboxConfig.voiceCloning.fileName) {
                let preview = `üé§ Voice Cloning Active: Using uploaded voice sample "${chatterboxConfig.voiceCloning.fileName}" with ${emotionLevel}% emotion and ${pacing}% pacing speed. The AI will speak in your custom voice!`;
                document.getElementById('voice-preview').textContent = preview;
                return;
            }
            
            // Default Chatterbox voice mode
            const config = voiceMatrix[gender][emotion];
            let preview = `Current: ${gender.charAt(0).toUpperCase() + gender.slice(1)} ${emotion} voice with ${emotionLevel}% emotion and ${pacing}% pacing speed. ${config.description}`;
            
            // Add contextual hints
            if (emotion === 'dramatic' && emotionLevel >= 80) {
                preview += ' üé≠ Maximum intensity for powerful delivery.';
            } else if (emotion === 'calm' && pacing >= 60) {
                preview += ' üòå Perfect for clear, measured delivery.';
            } else if (emotion === 'expressive' && emotionLevel >= 60) {
                preview += ' ‚ú® Optimized for engaging, natural speech.';
            }
            
            document.getElementById('voice-preview').textContent = preview;
        }

        // Test Chatterbox voice with current settings
        async function testChatterboxVoice() {
            if (!chatterboxConfig.enabled) {
                updateStatus('‚ùå TTS is disabled. Enable it first.');
                return;
            }

            const testText = `Hello! I'm your AI assistant powered by Chatterbox TTS. This is a ${chatterboxConfig.gender} ${chatterboxConfig.emotion} voice with ${Math.round(chatterboxConfig.exaggeration * 100)} percent emotion and advanced neural synthesis.`;
            
            updateStatus('üéµ Testing Chatterbox voice...');
            
            try {
                await synthesizeWithChatterbox(testText);
                updateStatus('‚úÖ Voice test completed successfully!');
            } catch (error) {
                console.error('Voice test failed:', error);
                updateStatus('‚ùå Voice test failed - check console for details');
            }
        }

        // Synthesize speech using Chatterbox TTS
        async function synthesizeWithChatterbox(text) {
            if (!chatterboxConfig.enabled) {
                console.log('TTS disabled, skipping synthesis');
                return;
            }

            try {
                updateStatus(chatterboxConfig.voiceCloning.enabled ? 
                    'üé§ Synthesizing with voice cloning...' : 
                    'üéµ Synthesizing with Chatterbox TTS...');
                
                // Prepare form data for voice cloning or JSON for regular synthesis
                let requestBody, headers;
                
                if (chatterboxConfig.voiceCloning.enabled && chatterboxConfig.voiceCloning.audioFile) {
                    // Voice cloning mode - use FormData to send audio file
                    const formData = new FormData();
                    formData.append('text', text);
                    formData.append('gender', chatterboxConfig.gender);
                    formData.append('emotion', chatterboxConfig.emotion);
                    formData.append('exaggeration', chatterboxConfig.exaggeration.toString());
                    formData.append('cfg_weight', chatterboxConfig.cfg_weight.toString());
                    formData.append('engine', 'chatterbox');
                    formData.append('voice_cloning', 'true');
                    formData.append('audio_prompt', chatterboxConfig.voiceCloning.audioFile);
                    
                    requestBody = formData;
                    headers = {}; // Don't set Content-Type, let browser set it for FormData
                } else {
                    // Regular synthesis mode
                    requestBody = JSON.stringify({
                        text: text,
                        gender: chatterboxConfig.gender,
                        emotion: chatterboxConfig.emotion,
                        exaggeration: chatterboxConfig.exaggeration,
                        cfg_weight: chatterboxConfig.cfg_weight,
                        engine: 'chatterbox'
                    });
                    headers = { 'Content-Type': 'application/json' };
                }
                
                const response = await fetch('/api/voice/synthesize', {
                    method: 'POST',
                    headers: headers,
                    body: requestBody
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // Stop any currently playing audio
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                
                // Play the new audio
                currentAudio = new Audio(audioUrl);
                currentAudio.play();
                
                currentAudio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    updateStatus('üé≠ Chatterbox TTS Ready');
                };
                
                updateStatus('üîä Playing Chatterbox synthesis...');
                
            } catch (error) {
                console.error('Chatterbox synthesis failed:', error);
                updateStatus('‚ùå Synthesis failed - trying fallback...');
                
                // Fallback to browser TTS if Chatterbox fails
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.9;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.8;
                    speechSynthesis.speak(utterance);
                    updateStatus('üîä Using browser TTS fallback');
                }
            }
        }

        // Microphone functionality (placeholder)
        function toggleMicrophone() {
            isListening = !isListening;
            const btn = document.getElementById('microphone-btn');
            const status = document.getElementById('mic-status');
            
            if (isListening) {
                btn.classList.add('listening');
                status.textContent = 'Listening...';
                updateStatus('üé§ Listening for voice input...');
                // TODO: Implement actual speech recognition
                setTimeout(() => {
                    toggleMicrophone(); // Auto-stop after demo
                    simulateResponse();
                }, 3000);
            } else {
                btn.classList.remove('listening');
                status.textContent = 'Click to Start';
                updateStatus('üé≠ Chatterbox TTS Ready');
            }
        }

        // Simulate AI response for demo
        function simulateResponse() {
            const responses = [
                "Hello! I'm your AI assistant powered by Chatterbox TTS with emotion control.",
                "I can help you with various tasks using high-quality neural voice synthesis.",
                "This is an example of expressive speech with advanced emotion control.",
                "Chatterbox TTS provides the most natural and engaging voice experience."
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            addToTranscript('Assistant', randomResponse);
            synthesizeWithChatterbox(randomResponse);
        }

        // Transcript functionality
        function toggleTranscript() {
            const panel = document.getElementById('transcript-panel');
            panel.classList.toggle('hidden');
        }

        function addToTranscript(speaker, text) {
            const content = document.getElementById('transcript-content');
            const entry = document.createElement('div');
            entry.innerHTML = `<strong>${speaker}:</strong> ${text}`;
            entry.style.marginBottom = '10px';
            content.appendChild(entry);
            content.scrollTop = content.scrollHeight;
        }

        // Stop all audio
        function stopAll() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            isListening = false;
            document.getElementById('mic-status').textContent = 'Click to Start';
            document.getElementById('microphone-btn').classList.remove('listening');
            updateStatus('‚èπÔ∏è All audio stopped');
        }

        // Update status display
        function updateStatus(message) {
            document.getElementById('current-status').textContent = message;
            console.log('Status:', message);
        }

        // Add some CSS for dynamic effects
        const style = document.createElement('style');
        style.textContent = `
            .mic-btn.listening {
                background: #f44336 !important;
                animation: pulse 1s infinite;
            }
            .transcript-panel.hidden {
                display: none;
            }
            .transcript-panel {
                position: fixed;
                top: 50px;
                right: 20px;
                width: 300px;
                height: 400px;
                background: white;
                border: 2px solid #4CAF50;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 1000;
                overflow-y: auto;
            }
        `;
        document.head.appendChild(style);

        // Initialize with a welcome message
        setTimeout(() => {
            if (chatterboxConfig.enabled) {
                synthesizeWithChatterbox("Welcome to your AI Voice Assistant powered by Chatterbox TTS! I'm speaking with a natural female expressive voice using advanced neural synthesis. You can easily switch between male and female voices, adjust the emotional tone from calm to dramatic, and even clone any voice by uploading a short audio sample!");
            }
        }, 1000);
    </script>
</body>
</html> 